@using eSecurity.Client.Security.Identity
@using eSecurity.Core.Common.DTOs
@inject UserState UserState
@inject ISnackbar Snackbar
@inject IUserService UserService

@if (_confirmed)
{
    @AccessConfirmed
}
else
{
    if (_model is not null)
    {
        <MudGrid Justify="Justify.Center">
            <MudItem xs="3">
                <MudStack Justify="Justify.Center">
                    <MudTextM3 Typo="TypoM3.Headline" Size="Size.Medium" Align="Align.Center">
                        Confirm access
                    </MudTextM3>
                    <MudPaper Outlined="true" Class="px-5 py-4">
                        <MudGrid>
                            <MudItem xs="1">
                                <MudAvatar Size="Size.Medium">
                                    <MudImage
                                        Src="/images/avatar.jpg"
                                        Alt="Avatar"
                                        FallbackSrc="/images/avatar.jpg"/>
                                </MudAvatar>
                            </MudItem>
                            <MudItem xs="10">
                                <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
                                    <MudTextM3 Class="pt-2">
                                        Signed-in as <strong>@UserState.Credentials?.Username</strong>
                                    </MudTextM3>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                    @switch (_model.PreferredMethod)
                    {
                        case VerificationMethod.Email:
                        {
                            <EmailConfirmation
                                Model="_model"
                                Context="Context"
                                OnMethodChanged="ChangeMethodAsync"
                                OnAccessConfirmed="ConfirmAccessAsync"/>
                            break;
                        }
                        case VerificationMethod.Passkey:
                        {
                            <PasskeyConfirmation
                                Model="_model"
                                Context="Context"
                                OnMethodChanged="ChangeMethodAsync"
                                OnAccessConfirmed="ConfirmAccessAsync"/>
                            break;
                        }
                        case VerificationMethod.AuthenticatorApp:
                        {
                            <AuthenticatorConfirmation
                                Model="_model"
                                Context="Context"
                                OnMethodChanged="ChangeMethodAsync"
                                OnAccessConfirmed="ConfirmAccessAsync"/>
                            break;
                        }
                    }
                </MudStack>
            </MudItem>
        </MudGrid>
    }
}

@code {
    [Parameter] public ConfirmationContext Context { get; set; } = null!;
    [Parameter] public RenderFragment AccessConfirmed { get; set; } = null!;

    private UserVerificationData? _model;
    private bool _confirmed;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task ChangeMethodAsync(VerificationMethod method)
    {
        await InvokeAsync(StateHasChanged);
        _model?.PreferredMethod = method;
    }

    private async Task ConfirmAccessAsync()
    {
        _confirmed = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadAsync()
    {
        var result = await UserService.GetUserVerificationMethodsAsync(UserState.UserId);

        if (result.Succeeded) _model = result.Get()!;
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

}