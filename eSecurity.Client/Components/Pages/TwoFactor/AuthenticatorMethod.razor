
@using eSecurity.Client.Security
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authentication.SignIn
@using eSecurity.Core.Security.Authentication.TwoFactor

@inject CodeModelValidator Validator
@inject UserState UserState
@inject ISnackbar Snackbar
@inject ISecurityService SecurityService

<MudPaper Outlined="true" Class="pa-5">
    <MudStack Spacing="3">
        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
            Enter the code from your two-factor authentication app or browser extension below.
        </MudTextM3>
        <MudForm @ref="_form" Model="_model" Validation="Validator.ValidateValue">
            <MudTextFieldExtended
                Mask="_mask"
                Placeholder="XXXXXX"
                Variant="Variant.Outlined"
                Margin="Margin.Dense"
                Immediate="true"
                Clearable="true"
                @bind-Value="_model.Code"
                For="() => _model.Code"/>
        </MudForm>
        <MudStack Spacing="2">
            <MudButton
                Disabled="_model.Code.Length < 6"
                Size="Size.Medium"
                Color="Color.Primary"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                OnClick="@(async () => await OnSignInAsync())">
                Verify
            </MudButton>
        </MudStack>
    </MudStack>
</MudPaper>
<MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
    <MudDivider Style="max-width: 45%"/>
    <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
    <MudDivider Style="max-width: 45%"/>
</MudStack>
<MudPaper Outlined="true" Class="pa-5">
    <MudStack Spacing="2">
        @if (Methods.Any(x => x.Method == TwoFactorMethod.Passkey))
        {
            <MudButton
                Color="Color.Info"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                Size="Size.Medium"
                OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Passkey))">
                Passkey
            </MudButton>
        }
        @if (Methods.Any(x => x.Method == TwoFactorMethod.Sms))
        {
            <MudButton
                Color="Color.Default"
                Variant="Variant.Outlined"
                ButtonType="ButtonType.Button"
                Size="Size.Medium"
                OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Sms))">
                SMS
            </MudButton>
        }
        <MudButton
            Color="Color.Error"
            Variant="Variant.Filled"
            ButtonType="ButtonType.Button"
            Size="Size.Medium"
            OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.RecoveryCode))">
            Recovery codes
        </MudButton>
    </MudStack>
</MudPaper>

@code {

    [SupplyParameterFromQuery(Name = "id")]
    public Guid UserId { get; set; }

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; }

    [Parameter] public EventCallback<TwoFactorMethod> OnChangeMethod { get; set; }

    [Parameter] public EventCallback OnSignIn { get; set; }

    [Parameter] public List<UserTwoFactorMethod> Methods { get; set; } = [];

    private CodeModel _model = new();
    private MudForm _form = new();
    private readonly PatternMask _mask = new("000000");

    private async Task OnSignInAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new SignInRequest()
            {
                Payload = new AuthenticatorSignInPayload()
                {
                    Code = _model.Code,
                    UserId = UserId
                }
            };

            var result = await SecurityService.SignInAsync(request);

            if (result.Succeeded)
            {
                var response = result.Get()!;

                UserState.UserId = response.UserId;
                await OnSignIn.InvokeAsync();
            }
            else Snackbar.Add(result.GetError().Description, Severity.Error);
        }
    }
}