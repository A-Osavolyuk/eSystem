@page "/account/2fa/sign-in"

@using eSecurity.Client.Security
@using eSecurity.Client.Security.Identity
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authentication.TwoFactor

@inherits PageBase

@inject IUserService UserService
@inject ISecurityService SecurityService

<Title Text="Two-factor login"/>

@if (_methods.Any())
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="3" Style="margin-top: 50px">
            <MudStack Spacing="1">
                <MudPaper Class="pa-3" Outlined="true">
                    <MudStack Spacing="3" Justify="Justify.Center" AlignItems="AlignItems.Center">
                        <MudIcon Size="Size.Large" Icon="@Icons.Material.Outlined.LockPerson"/>
                        @if (_preferredMethod != TwoFactorMethod.RecoveryCode)
                        {
                            <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                                Two-factor authentication
                            </MudTextM3>
                        }
                        else
                        {
                            <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                                Two-factor recovery
                            </MudTextM3>
                        }
                    </MudStack>
                </MudPaper>
                @switch (_preferredMethod)
                {
                    case TwoFactorMethod.AuthenticatorApp:
                    {
                        <AuthenticatorMethod
                            Methods="_methods"
                            OnSignIn="@(() => AuthenticationManager.Authorize())"
                            OnChangeMethod="ChangeMethod"/>
                        break;
                    }
                    case TwoFactorMethod.Passkey:
                    {
                        <PasskeyMethod
                            Methods="_methods"
                            OnSignIn="@(() => AuthenticationManager.Authorize())"
                            OnChangeMethod="ChangeMethod"/>
                        break;
                    }
                    case TwoFactorMethod.RecoveryCode:
                    {
                        <RecoveryCodeMethod
                            Methods="_methods"
                            OnSignIn="@(() => AuthenticationManager.Authorize())"
                            OnChangeMethod="ChangeMethod"/>
                        break;
                    }
                }
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {

    [SupplyParameterFromQuery(Name = "sid")]
    public Guid SessionId { get; set; }

    private List<UserTwoFactorMethod> _methods = [];
    private TwoFactorMethod _preferredMethod;

    protected override async Task OnInitializedAsync()
    {
        var result = await SecurityService.GetSignInSessionAsync(SessionId);
        if (result.Succeeded)
        {
            var response = result.Get()!;
            UserState.UserId = response.UserId;
            await LoadMethods();
        }
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }
    
    private async Task LoadMethods()
    {
        var result = await UserService.GetUserTwoFactorMethodsAsync(UserState.UserId);
        if (result.Succeeded)
        {
            _methods = result.Get()!;
            _preferredMethod = _methods.Single(x => x.Preferred).Method;
        }
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }

    private void ChangeMethod(TwoFactorMethod method) => _preferredMethod = method;
}
