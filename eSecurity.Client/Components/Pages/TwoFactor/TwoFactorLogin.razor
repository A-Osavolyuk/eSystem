@page "/account/2fa/sign-in"

@using eSecurity.Client.Security.Identity
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authentication.TwoFactor

@inherits PageBase

@inject IUserService UserService

<Title Text="Two-factor login"/>

@if (_methods.Any())
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="3">
            <MudStack Spacing="3" Justify="Justify.Center" AlignItems="AlignItems.Center">
                <MudIcon Size="Size.Large" Icon="@Icons.Material.Outlined.LockPerson"/>
                @if (_preferredMethod != TwoFactorMethod.RecoveryCode)
                {
                    <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                        Two-factor authentication
                    </MudTextM3>
                }
                else
                {
                    <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                        Two-factor recovery
                    </MudTextM3>
                }
                @switch (_preferredMethod)
                {
                    case TwoFactorMethod.AuthenticatorApp:
                    {
                        <AuthenticatorMethod
                            Methods="_methods"
                            OnSignIn="SignIn"
                            OnChangeMethod="ChangeMethod"/>
                        break;
                    }
                    case TwoFactorMethod.Passkey:
                    {
                        <PasskeyMethod
                            Methods="_methods"
                            OnSignIn="SignIn"
                            OnChangeMethod="ChangeMethod"/>
                        break;
                    }
                    case TwoFactorMethod.RecoveryCode:
                    {
                        <RecoveryCodeMethod
                            Methods="_methods"
                            OnSignIn="SignIn"
                            OnChangeMethod="ChangeMethod"/>
                        break;
                    }
                }
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {
    [SupplyParameterFromQuery(Name = "id")]
    public Guid UserId { get; set; }

    private List<UserTwoFactorMethod> _methods = [];
    private TwoFactorMethod _preferredMethod;

    protected override async Task OnInitializedAsync()
    {
        var result = await UserService.GetUserTwoFactorMethodsAsync(UserId);

        if (result.Succeeded)
        {
            _methods = result.Get()!;
            _preferredMethod = _methods.Single(x => x.Preferred).Method;
        }
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

    private void ChangeMethod(TwoFactorMethod method)
    {
        _preferredMethod = method;
    }

    private void SignIn()
    {
        AuthenticationManager.Authorize();
    }
}
