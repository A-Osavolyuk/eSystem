@using eSecurity.Client.Common.JS.WebAuthN
@using eSecurity.Client.Security
@using eSecurity.Client.Security.Credentials.PublicKey
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Common.Responses
@using eSecurity.Core.Security.Authentication.SignIn
@using eSecurity.Core.Security.Authentication.TwoFactor
@using eSecurity.Core.Security.Credentials.PublicKey

@inject UserState UserState
@inject WebAuthNManager WebAuthNManager
@inject ISnackbar Snackbar
@inject IPasskeyService PasskeyService
@inject ISecurityService SecurityService

<MudStack Spacing="4" Class="w-100">
    <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
        Authenticate using your passkey.
    </MudTextM3>
    <MudStack Spacing="2">
        <MudButton
            FullWidth="true"
            Size="Size.Medium"
            Color="Color.Success"
            Variant="Variant.Filled"
            ButtonType="ButtonType.Button"
            OnClick="@(async () => await OnSignInAsync())">
            Use passkey
        </MudButton>
        <MudButton
            FullWidth="true"
            Color="Color.Default"
            Variant="Variant.Outlined"
            ButtonType="ButtonType.Button"
            Size="Size.Medium"
            OnClick="@(() => Expand())"
            EndIcon="@GetIcon()">
            More options
        </MudButton>
        <MudCollapse Expanded="_expanded" Class="w-100">
            <MudDivider Class="my-2"/>
            <MudStack Spacing="2">
                <MudButton
                    FullWidth="true"
                    Color="Color.Default"
                    Variant="Variant.Outlined"
                    ButtonType="ButtonType.Button"
                    Size="Size.Medium"
                    OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.AuthenticatorApp))">
                    Authenticator app
                </MudButton>
                @if (Methods.Any(x => x.Method == TwoFactorMethod.Sms))
                {
                    <MudButton
                        Color="Color.Default"
                        Variant="Variant.Outlined"
                        ButtonType="ButtonType.Button"
                        Size="Size.Medium"
                        OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Sms))">
                        SMS
                    </MudButton>
                }
                <MudButton
                    FullWidth="true"
                    Color="Color.Error"
                    Variant="Variant.Outlined"
                    ButtonType="ButtonType.Button"
                    Size="Size.Medium"
                    OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.RecoveryCode))">
                    Recovery codes
                </MudButton>
            </MudStack>
        </MudCollapse>
    </MudStack>
</MudStack>

@code {
    [Parameter] 
    public EventCallback<TwoFactorMethod> OnChangeMethod { get; set; }
    
    [Parameter] 
    public EventCallback OnSignIn { get; set; }

    [Parameter] 
    public List<UserTwoFactorMethod> Methods { get; set; } = [];

    [SupplyParameterFromQuery(Name = "id")]
    public Guid UserId { get; set; }

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; }

    private bool _expanded;

    private async Task OnSignInAsync()
    {
        var request = new GenerateRequestOptionsRequest() { UserId = UserId };
        var result = await PasskeyService.GenerateRequestOptionsAsync(request);

        if (result.Succeeded)
        {
            var options = result.Get<PublicKeyCredentialRequestOptions>()!;
            var authenticateResult = await WebAuthNManager.AuthenticateAsync(options);
            if (authenticateResult.Success)
            {
                var credential = authenticateResult.Get<PublicKeyCredential>();
                await SignInAsync(credential);
            }
        }
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

    private async Task SignInAsync(PublicKeyCredential credential)
    {
        var request = new SignInRequest()
        {
            Payload = new PasskeySignInPayload()
            {
                Credential = credential,
            }
        };
        var result = await SecurityService.SignInAsync(request);

        if (result.Succeeded)
        {
            var response = result.Get<SignInResponse>()!;

            UserState.UserId = response.UserId;
            await OnSignIn.InvokeAsync();
        }
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

    private void Expand() => _expanded = !_expanded;
    private string GetIcon() => _expanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore;
}