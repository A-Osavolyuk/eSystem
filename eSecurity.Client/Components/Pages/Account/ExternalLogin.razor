@using System.Text.Json
@using eSecurity.Core.Security.Authorization.OAuth
@using eSecurity.Core.Security.Authorization.OAuth.Constants
@using eSystem.Core.Security.Cryptography.Encoding

@inject NavigationManager NavigationManager
@inject IConfiguration Configuration

<MudPaper Outlined Class="pa-3">
    <MudGrid Spacing="1" Justify="Justify.Center">
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.Google"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.Google))"
                Color="Color.Primary"
                FullWidth="true">
                Google
            </MudButton>
        </MudItem>
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.Facebook"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.Facebook))"
                Color="Color.Primary"
                FullWidth="true">
                Facebook
            </MudButton>
        </MudItem>
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.Microsoft"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.Microsoft))"
                Color="Color.Primary"
                FullWidth="true">
                Microsoft
            </MudButton>
        </MudItem>
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.X"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.X))"
                Color="Color.Primary"
                FullWidth="true">
                X
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; }
    
    private string BuildUrl(string type)
    {
        var builder = QueryBuilder.Create()
            .WithUri($"{Configuration["services:proxy:http:0"]!}/api/v1/OAuth/login")
            .WithQueryParam("provider", type)
            .WithQueryParam("returnUri", $"{NavigationManager.BaseUri}account/oauth/sign-in");
        
        if (!string.IsNullOrEmpty(ReturnUrl))
        {
            var queryParams = QueryParser.GetQueryParameters(ReturnUrl);
            var state = new OAuthState()
            {
                ResponseType = queryParams.GetValueOrDefault("response_type"),
                ClientId = queryParams.GetValueOrDefault("client_id"),
                RedirectUri = queryParams.GetValueOrDefault("redirect_uri"),
                Scope = queryParams.GetValueOrDefault("scope"),
                Nonce = queryParams.GetValueOrDefault("nonce"),
                State = queryParams.GetValueOrDefault("state"),
                Prompt = queryParams.GetValueOrDefault("prompt")
            };
            var stateJson = JsonSerializer.Serialize(state);
            var stateBytes = Encoding.UTF8.GetBytes(stateJson);
            var base64State = WebEncoders.Base64UrlEncode(stateBytes);
            
            builder.WithQueryParam("state", base64State);
        }

        return builder.Build();
    }
}