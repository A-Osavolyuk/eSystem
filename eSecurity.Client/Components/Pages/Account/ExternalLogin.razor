@using System.Text.Json
@using eSecurity.Client.Security.Authentication.Oidc.Clients
@using eSecurity.Core.Security.Authorization.OAuth
@using eSecurity.Core.Security.Authorization.OAuth.Constants
@using eSystem.Core.Security.Authentication.Oidc.Authorization
@using eSystem.Core.Security.Cryptography.Encoding

@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@inject IOptions<ClientOptions> ClientOptions

<MudPaper Outlined Class="pa-3">
    <MudGrid Spacing="1" Justify="Justify.Center">
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.Google"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.Google))"
                Color="Color.Primary"
                FullWidth="true">
                Google
            </MudButton>
        </MudItem>
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.Facebook"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.Facebook))"
                Color="Color.Primary"
                FullWidth="true">
                Facebook
            </MudButton>
        </MudItem>
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.Microsoft"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.Microsoft))"
                Color="Color.Primary"
                FullWidth="true">
                Microsoft
            </MudButton>
        </MudItem>
        <MudItem xs="6">
            <MudButton
                ButtonType="ButtonType.Button"
                StartIcon="@Icons.Custom.Brands.X"
                Variant="Variant.Filled"
                Href="@(BuildUrl(ExternalAccounts.X))"
                Color="Color.Primary"
                FullWidth="true">
                X
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; }
    
    private string BuildUrl(string type)
    {
        var builder = QueryBuilder.Create()
            .WithUri($"{Configuration["services:proxy:https:0"]!}/api/v1/OAuth/login")
            .WithQueryParam("provider", type)
            .WithQueryParam("returnUri", $"{NavigationManager.BaseUri}account/oauth/sign-in");

        OAuthState? state;
        if (!string.IsNullOrEmpty(ReturnUrl))
        {
            var queryParams = QueryParser.GetQueryParameters(ReturnUrl);
            state = new OAuthState()
            {
                ResponseType = queryParams.GetValueOrDefault("response_type"),
                ClientId = queryParams.GetValueOrDefault("client_id"),
                RedirectUri = queryParams.GetValueOrDefault("redirect_uri"),
                Scope = queryParams.GetValueOrDefault("scope"),
                Nonce = queryParams.GetValueOrDefault("nonce"),
                State = queryParams.GetValueOrDefault("state"),
                Prompt = queryParams.GetValueOrDefault("prompt")
            };
        }
        else
        {
            var options = ClientOptions.Value;
            state = new OAuthState()
            {
                ResponseType = ResponseTypes.Code,
                ClientId = options.ClientId,
                RedirectUri = options.CallbackUri,
                Scope = string.Join(" ", options.Scopes),
                Nonce = "1234567890",
                State = "1234567890",
                Prompt = Prompts.Consent
            };
        }
        
        var stateJson = JsonSerializer.Serialize(state);
        var stateBytes = Encoding.UTF8.GetBytes(stateJson);
        var base64State = WebEncoders.Base64UrlEncode(stateBytes);
            
        builder.WithQueryParam("state", base64State);

        return builder.Build();
    }
}