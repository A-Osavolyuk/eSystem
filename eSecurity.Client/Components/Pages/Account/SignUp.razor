@page "/account/sign-up"
@using eSecurity.Client.Components.Pages.OAuth
@using eSecurity.Client.Security
@inherits PageBase

@inject RegistrationValidator Validator
@inject ISecurityService SecurityService

<Title Text="Sign up for eSecurity"/>

<MudGrid Justify="Justify.Center">
    <MudItem xs="4" Style="margin-top: 50px">
        <MudStack Spacing="1" Justify="Justify.Center">
            <MudPaper Outlined Class="pa-3">
                <MudTextM3 Align="Align.Center" Typo="TypoM3.Headline" Size="Size.Small">
                    Sign up for eSecurity
                </MudTextM3>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudStack Spacing="2">
                    <MudForm
                        @ref="_form"
                        Model="_model"
                        Validation="Validator.ValidateValue">
                        <MudTextFieldExtended
                            @bind-Value="_model.Username"
                            For="(() => _model.Username)"
                            InputType="InputType.Email"
                            Label="Username"
                            Immediate="true"
                            Margin="Margin.Dense"
                            Variant="Variant.Outlined"
                            Error="_showUsernameError"
                            ErrorText="@_usernameError"/>
                        <MudTextFieldExtended
                            @bind-Value="_model.Email"
                            For="(() => _model.Email)"
                            InputType="InputType.Email"
                            Label="Email"
                            Immediate="true"
                            Margin="Margin.Dense"
                            Variant="Variant.Outlined"
                            Error="_showEmailError"
                            ErrorText="@_emailError"/>
                        <MudPasswordField
                            PasswordMode="true"
                            @bind-Value="_model.Password"
                            For="(() => _model.Password)"
                            Label="Password"
                            InputType="InputType.Password"
                            IconSize="Size.Small"
                            Margin="Margin.Dense"
                            Immediate
                            Variant="Variant.Outlined"/>
                    </MudForm>
                    <MudLoadingButton
                        ButtonType="ButtonType.Button"
                        StartIcon="@Icons.Material.Filled.AppRegistration"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        FullWidth="true"
                        Size="Size.Medium"
                        OnClick="@(async () => await OnSubmit())">
                        Create account
                    </MudLoadingButton>
                </MudStack>
            </MudPaper>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
                <MudDivider Style="max-width: 45%"/>
                <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
                <MudDivider Style="max-width: 45%"/>
            </MudStack>
            <MudPaper Class="pa-3" Outlined="true">
                <Providers/>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudTextM3 Align="Align.Center" Typo="TypoM3.Body" Size="Size.Medium">
                    Already have an account?
                    <MudLink Typo="Typo.body2" Href="@Links.Account.SignIn">
                        Sign in
                    </MudLink>
                </MudTextM3>
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

@code {
    private readonly SignUpModel _model = new();

    private MudForm _form = new();

    private bool _showUsernameError;
    private string? _usernameError;
    
    private bool _showEmailError;
    private string? _emailError;

    private async Task OnSubmit()
    {
        ResetValidation();
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new SignUpRequest()
            {
                Email = _model.Email,
                Password = _model.Password,
                Username = _model.Username
            };

            var result = await SecurityService.SignUpAsync(request);

            if (result.Succeeded)
            {
                var response = result.Get()!;

                Snackbar.Add("Successfully signed-up. Not you need to verify your email address.", Severity.Success);

                var builder = QueryBuilder.Create()
                    .WithUri(Links.Account.CompleteRegistrationPage)
                    .WithQueryParam("id", response.UserId.ToString())
                    .WithQueryParam("return_url", Links.Account.SignIn);
                
                NavigationManager.NavigateTo(builder.Build());
            }
            else
            {
                var error = result.GetError();
                if (error.Code == Errors.Common.UsernameTaken)
                {
                    _showUsernameError = true;
                    _usernameError = error.Description;
                }
                else if (error.Code == Errors.Common.EmailTaken)
                {
                    _showEmailError = true;
                    _emailError = error.Description;
                }
                else Snackbar.Add(result.GetError().Description, Severity.Error);
            }
        }
    }

    private void ResetValidation()
    {
        _showEmailError = false;
        _showUsernameError = false;
        _usernameError = null;
        _emailError = null;
    }
}
