@page "/account/sign-in"
@using eSecurity.Client.Security
@using eSecurity.Core.Security.Authentication.SignIn

@inherits PageBase

@inject LoginValidator Validator
@inject ISecurityService SecurityService

<Title Text="Sign in for eSecurity"/>

<MudGrid Justify="Justify.Center">
    <MudItem xs="4" Style="margin-top: 150px">
        <MudStack Spacing="1" Justify="Justify.Center">
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center" Typo="Typo.h4">
                    Sign in for eSecurity
                </MudText>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudForm
                    @ref="_form"
                    Model="Model"
                    Validation="Validator.ValidateValue">
                    <MudTextField
                        @bind-Value="Model.Login"
                        For="(() => Model.Login)"
                        Label="Login"
                        Immediate
                        Variant="Variant.Outlined"/>
                    <MudPasswordField
                        PasswordMode="true"
                        @bind-Value="Model.Password"
                        For="(() => Model.Password)"
                        Label="Password"
                        Immediate
                        Variant="Variant.Outlined"/>
                    <MudLoadingButton
                        LoadingAdornment="Adornment.End"
                        ButtonType="ButtonType.Button"
                        OnClick="@(async () => await OnSignInAsync())"
                        StartIcon="@Icons.Material.Filled.Login"
                        Disabled="@(string.IsNullOrEmpty(Model.Password) || string.IsNullOrEmpty(Model.Login))"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        Class="mt-3"
                        FullWidth="true">
                        Sign in
                    </MudLoadingButton>
                </MudForm>
            </MudPaper>
            <MudPaper Class="pa-3" Outlined="true">
                <MudLoadingButton
                    LoadingAdornment="Adornment.End"
                    ButtonType="ButtonType.Button"
                    StartIcon="@Icons.Material.Filled.Key"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Href="@Links.Account.PasskeySignInPage"
                    FullWidth="true">
                    Sign in with Passkey
                </MudLoadingButton>
            </MudPaper>
            <ExternalLogin/>
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center">
                    Do not have an account yet?
                    <MudLink Href="@Links.Account.SignUp">
                        Sign up
                    </MudLink>
                </MudText>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center">
                    Forgot your password?
                    <MudLink Href="@OnForgotPassword()">
                        Reset password
                    </MudLink>
                </MudText>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center">
                    Lost access to your account?
                    <MudLink Href="@OnRecoverAccount()">
                        Recover account
                    </MudLink>
                </MudText>
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

@code {

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; } = string.Empty;

    private LoginModel Model { get; set; } = new();
    private MudForm _form = new();

    private async Task OnSignInAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new SignInRequest()
            {
                Payload = new PasswordSignInPayload()
                {
                    Password = Model.Password,
                    Login = Model.Login
                }
            };
            var result = await SecurityService.SignInAsync(request);

            if (result.Succeeded)
            {
                var response = result.Get()!;

                if (response.IsTwoFactorEnabled)
                {
                    Snackbar.Add(result.GetError().Description, Severity.Success);

                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Account.TwoFactorLoginPage)
                        .WithQueryParam("id", response.UserId.ToString());

                    if (!string.IsNullOrEmpty(ReturnUrl))
                        builder.WithQueryParam("return_url", ReturnUrl);

                    NavigationManager.NavigateTo(builder.Build());
                    return;
                }

                UserState.UserId = response.UserId;
                AuthenticationManager.Authorize();
            }
            else
            {
                var error = result.GetError();

                if (error.Code == Errors.Common.UntrustedDevice)
                {
                    var deviceId = error.Details["deviceId"].ToString()!;
                    var userId = error.Details["userId"].ToString()!;
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Account.DeviceTrustPage)
                        .WithQueryParam("device", deviceId)
                        .WithQueryParam("user", userId);

                    if (!string.IsNullOrEmpty(ReturnUrl))
                        builder.WithQueryParam("return_url", ReturnUrl);

                    NavigationManager.NavigateTo(builder.Build());

                    Snackbar.Add(result.GetError().Description, Severity.Info);
                    return;
                }

                if (error.Code == Errors.Common.UnverifiedEmail)
                {
                    var userId = error.Details["userId"].ToString()!;
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Account.CompleteRegistrationPage)
                        .WithQueryParam("id", userId);

                    Snackbar.Add(result.GetError().Description, Severity.Info);
                    NavigationManager.NavigateTo(builder.Build());
                    return;
                }

                if (error.Code == Errors.Common.FailedLoginAttempt)
                {
                    var maxFailedLoginAttempts = Convert.ToInt32(error.Details["maxFailedLoginAttempts"]);
                    var failedLoginAttempts = Convert.ToInt32(error.Details["failedLoginAttempts"]);
                    var attemptsLeft = maxFailedLoginAttempts- failedLoginAttempts;
                    var message = $"Incorrect password. You have {attemptsLeft} attempts left.";
                    Snackbar.Add(message, Severity.Error);
                    return;
                }

                if (error.Code is Errors.Common.TooManyFailedLoginAttempts or Errors.Common.AccountLockedOut)
                {
                    var userId = error.Details["userId"].ToString()!;
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Account.LockedOutPage)
                        .WithQueryParam("id", userId);

                    NavigationManager.NavigateTo(builder.Build());
                }
                else Snackbar.Add(result.GetError().Description, Severity.Error);
            }
        }
    }

    private string OnForgotPassword()
    {
        return QueryBuilder.Create()
            .WithUri(Links.Account.ForgotPasswordPage)
            .WithQueryParam("return_url", Links.Account.SignIn)
            .Build();
    }

    private string OnRecoverAccount()
    {
        return QueryBuilder.Create()
            .WithUri(Links.Account.RecoverPage)
            .WithQueryParam("return_url", Links.Account.SignIn)
            .Build();
    }

}
