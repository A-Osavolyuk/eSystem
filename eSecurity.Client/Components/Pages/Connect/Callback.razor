@page "/connect/callback"

@using eSecurity.Client.Common.JS.Fetch
@using eSecurity.Client.Security.Authentication
@using eSecurity.Client.Security.Authentication.Oidc
@using eSecurity.Client.Security.Authentication.Oidc.Clients
@using eSecurity.Client.Security.Authentication.Oidc.Token
@using eSecurity.Core.Common.DTOs
@using eSystem.Core.Security.Authentication.Oidc.Constants
@using eSecurity.Core.Common.Responses

@inherits PageBase

@inject IConnectService ConnectService
@inject IOptions<ClientOptions> ClientOptions
@inject IFetchClient FetchClient
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject TokenProvider TokenProvider

@code {

    [SupplyParameterFromQuery(Name = "code")]
    public string Code { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "state")]
    public string State { get; set; } = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var options = ClientOptions.Value;

            var request = new TokenRequest()
            {
                ClientId = options.ClientId,
                ClientSecret = options.ClientSecret,
                RedirectUri = options.CallbackUri,
                GrantType = GrantTypes.AuthorizationCode,
                Code = Code,
            };

            var result = await ConnectService.TokenAsync(request);

            if (result.Succeeded)
            {
                var response = result.Get<TokenResponse>();

                await SignInAsync(
                    response.AccessToken,
                    response.IdToken!,
                    response.RefreshToken!
                );
                
                NavigationManager.NavigateTo(Links.Account.Profile);
            }
        }
    }

    private async Task SignInAsync(string accessToken, string idToken, string refreshToken)
    {
        TokenProvider.AccessToken = accessToken;
        TokenProvider.IdToken = idToken;
        
        var tokenIdentity = new TokenIdentity()
        {
            RefreshToken = refreshToken,
            IdToken = idToken
        };
        
        var fetchOptions = new FetchOptions()
        {
            Url = $"{NavigationManager.BaseUri}api/authentication/sign-in",
            Method = HttpMethod.Post,
            Body = tokenIdentity
        };

        var result = await FetchClient.FetchAsync(fetchOptions);

        if (result.Succeeded)
        {
            var response = result.Get<SignIdentity>();
            var claims = response.Claims.Select(c => new Claim(c.Type, c.Value));
            var claimsIdentity = new ClaimsIdentity(claims, response.Scheme);
            var claimPrincipal = new ClaimsPrincipal(claimsIdentity);
            (AuthenticationStateProvider as ClaimAuthenticationStateProvider)!.SignIn(claimPrincipal);
        }
    }

}