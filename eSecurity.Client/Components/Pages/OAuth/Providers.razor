@using eSecurity.Client.Security.Authentication.Oidc.Clients
@using eSecurity.Core.Security.Authorization.OAuth
@using eSecurity.Core.Security.Authorization.OAuth.Constants
@using eSystem.Core.Security.Authentication.Oidc.Authorization

@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@inject IOptions<ClientOptions> ClientOptions

<MudStack Spacing="1">
    <MudButton
        Size="Size.Small"
        ButtonType="ButtonType.Button"
        StartIcon="@Icons.Custom.Brands.Google"
        Variant="Variant.Filled"
        Href="@(BuildUrl(ExternalAccounts.Google))"
        Color="Color.Primary"
        FullWidth="true">
        Continue with Google
    </MudButton>
    <MudButton
        Size="Size.Small"
        ButtonType="ButtonType.Button"
        StartIcon="@Icons.Custom.Brands.Facebook"
        Variant="Variant.Filled"
        Href="@(BuildUrl(ExternalAccounts.Facebook))"
        Color="Color.Primary"
        FullWidth="true">
        Continue with Facebook
    </MudButton>
    <MudButton
        Size="Size.Small"
        ButtonType="ButtonType.Button"
        StartIcon="@Icons.Custom.Brands.Microsoft"
        Variant="Variant.Filled"
        Href="@(BuildUrl(ExternalAccounts.Microsoft))"
        Color="Color.Primary"
        FullWidth="true">
        Continue with Microsoft
    </MudButton>
    <MudButton
        Size="Size.Small"
        ButtonType="ButtonType.Button"
        StartIcon="@Icons.Custom.Brands.X"
        Variant="Variant.Filled"
        Href="@(BuildUrl(ExternalAccounts.X))"
        Color="Color.Primary"
        FullWidth="true">
        Continue with X
    </MudButton>
</MudStack>

@code {

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; }

    private string BuildUrl(string type)
    {
        var builder = QueryBuilder.Create()
            .WithUri($"{Configuration["services:proxy:https:0"]!}/api/v1/OAuth/login")
            .WithQueryParam("provider", type)
            .WithQueryParam("returnUri", $"{NavigationManager.BaseUri}account/oauth/handle");

        OAuthState? state;
        if (!string.IsNullOrEmpty(ReturnUrl))
        {
            var queryParams = QueryParser.GetQueryParameters(ReturnUrl);
            state = new OAuthState()
            {
                ResponseType = queryParams.GetValueOrDefault("response_type"),
                ClientId = queryParams.GetValueOrDefault("client_id"),
                RedirectUri = queryParams.GetValueOrDefault("redirect_uri"),
                Scope = queryParams.GetValueOrDefault("scope"),
                Nonce = queryParams.GetValueOrDefault("nonce"),
                State = queryParams.GetValueOrDefault("state"),
                Prompt = queryParams.GetValueOrDefault("prompt")
            };
        }
        else
        {
            var options = ClientOptions.Value;
            state = new OAuthState()
            {
                ResponseType = ResponseTypes.Code,
                ClientId = options.ClientId,
                RedirectUri = options.CallbackUri,
                Scope = string.Join(" ", options.Scopes),
                Nonce = Guid.NewGuid().ToString(),
                State = Guid.NewGuid().ToString(),
                Prompt = Prompts.Consent
            };
        }

        var stateJson = JsonSerializer.Serialize(state);
        var stateBytes = Encoding.UTF8.GetBytes(stateJson);
        var base64State = WebEncoders.Base64UrlEncode(stateBytes);

        builder.WithQueryParam("state", base64State);

        return builder.Build();
    }

}