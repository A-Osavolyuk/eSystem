@page "/account/oauth/sign-up"

@using eSecurity.Client.Security.Authorization.OAuth
@using eSecurity.Client.Security.Identity

@inherits PageBase

@inject IUserService UserService
@inject IOAuthService OAuthService

<Title Text="OAuth sign up"/>

@if (!string.IsNullOrEmpty(_provider))
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="3" Style="margin-top: 50px">
            <MudStack Spacing="1">
                <MudPaper Outlined="true" Class="pa-5">
                    <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small" Align="Align.Center">
                        Set an username
                    </MudTextM3>
                </MudPaper>
                <MudPaper Outlined Class="pa-5">
                    <MudStack Spacing="3">
                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                            You have been successfully signed-up via @_provider.
                        </MudTextM3>
                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                            Now you can set username, otherwise your email address will be used as username.
                        </MudTextM3>
                        <MudStack Spacing="1">
                            <MudForm @ref="_form" Model="_model">
                                <MudTextFieldExtended
                                    Label="Username"
                                    @bind-Value="_model.Username"
                                    Margin="Margin.Dense"
                                    Variant="Variant.Outlined"
                                    Immediate="true"
                                    Clearable="true"/>
                            </MudForm>
                        </MudStack>
                        <MudButton
                            Color="Color.Primary"
                            Variant="Variant.Filled"
                            ButtonType="ButtonType.Button"
                            Size="Size.Small">
                            Set username
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {

    [SupplyParameterFromQuery(Name = "sid")]
    public string SessionId { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "token")]
    public string Token { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "redirect_uri")]
    public string RedirectUri { get; set; } = string.Empty;

    private MudForm? _form = new();
    private SetUsernameModel _model = new();
    private string _provider = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var request = new LoadOAuthSessionRequest()
        {
            SessionId = Guid.Parse(SessionId),
            Token = Token
        };

        var result = await OAuthService.LoadSessionAsync(request);
        if (result.Succeeded)
        {
            var response = result.Get();
            UserState.UserId = response.UserId;
            _provider = response.Provider;
        }
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }

}