@page "account/oauth/handle"

@using eSecurity.Client.Security.Authorization.OAuth
@using eSecurity.Core.Security.Authorization.OAuth

@inherits PageBase

@inject IOAuthService OAuthService

<Title Text="Handling OAuth session..."/>

@code {
    [SupplyParameterFromQuery(Name = "sessionId")]
    public string SessionId { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "token")]
    public string Token { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "state")]
    public string State { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "error")]
    public string? ErrorCode { get; set; }

    [SupplyParameterFromQuery(Name = "error_description")]
    public string? ErrorDescription { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!string.IsNullOrEmpty(ErrorCode) && !string.IsNullOrEmpty(ErrorDescription))
        {
            NavigationManager.NavigateTo(QueryBuilder.Create()
                .WithUri(Links.OAuth.Error)
                .WithQueryParam("error", ErrorCode)
                .WithQueryParam("error_description", ErrorDescription)
                .Build());
        }
        else
        {
            var request = new LoadOAuthSessionRequest()
            {
                SessionId = Guid.Parse(SessionId),
                Token = Token
            };

            var result = await OAuthService.LoadSessionAsync(request);

            if (result.Succeeded)
            {
                var response = result.Get();
                UserState.UserId = response.UserId;

                if (response.Flow == OAuthFlow.SignIn)
                {
                    var encodedState = WebEncoders.Base64UrlDecode(State);
                    var stateJson = Encoding.UTF8.GetString(encodedState);
                    var state = JsonSerializer.Deserialize<OAuthState>(stateJson);

                    if (state is null)
                    {
                        NavigationManager.NavigateTo(QueryBuilder.Create()
                            .WithUri(Links.OAuth.Error)
                            .WithQueryParam("error", Errors.OAuth.InvalidRequestUri)
                            .WithQueryParam("error_description", "The state parameter is invalid.")
                            .Build());
                        
                        return;
                    }
                    
                    NavigationManager.NavigateTo(QueryBuilder.Create()
                        .WithUri(Links.OAuth.SignIn)
                        .WithQueryParam("redirect_uri", GetRedirectUri(state))
                        .Build());
                }
                else NavigationManager.NavigateTo(Links.OAuth.SignUp);
            }
            else
            {
                var error = result.GetError();
                Snackbar.Add(error.Description, Severity.Error);
            }
        }
    }
    
    private string GetRedirectUri(OAuthState state)
    {
        var builder = QueryBuilder.Create().WithUri(Links.Connect.Authorize);

        if (!string.IsNullOrEmpty(state!.ResponseType))
            builder.WithQueryParam("response_type", state.ResponseType);

        if (!string.IsNullOrEmpty(state.ClientId))
            builder.WithQueryParam("client_id", state.ClientId);

        if (!string.IsNullOrEmpty(state.RedirectUri))
            builder.WithQueryParam("redirect_uri", state.RedirectUri);

        if (!string.IsNullOrEmpty(state.Scope))
            builder.WithQueryParam("scope", state.Scope);

        if (!string.IsNullOrEmpty(state.Nonce))
            builder.WithQueryParam("nonce", state.Nonce);

        if (!string.IsNullOrEmpty(state.State))
            builder.WithQueryParam("state", state.State);

        if (!string.IsNullOrEmpty(state.Prompt))
            builder.WithQueryParam("prompt", state.Prompt);

        return builder.Build();
    }

}