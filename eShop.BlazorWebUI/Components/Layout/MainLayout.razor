@inherits LayoutComponentBase
@implements IDisposable

@inject NotificationsStateContainer NotificationsStateContainer
@inject AuthenticationStateProvider AuthenticationState
@inject NavigationManager NavigationManager
@inject INotificationService NotificationService
@inject IConfiguration Configuration
@inject ISnackbar Snackbar

<MudThemeProvider IsDarkMode/>
<MudDialogProvider/>
<MudSnackbarProvider/>
<MudPopoverProvider/>

<MudLayout>
    <MudAppBar Class="align-content-center" Elevation="1">
        <MudIconButton
            Icon="@Icons.Material.Filled.Menu"
            Color="Color.Inherit"
            Edge="Edge.Start"
            OnClick="@((e) => DrawerToggle())"/>
        <MudText
            Align="Align.Center"
            Typo="Typo.h5"
            Class="ml-3 cursor-pointer"
            @onclick="@(() => NavigationManager.NavigateTo("/products"))">
            eShop
        </MudText>
        <MudSpacer/>
        <AuthorizeView>
            <NotAuthorized>
                <MudButton
                    StartIcon="@Icons.Material.Filled.Login"
                    Color="Color.Primary"
                    Href="/account/login">
                    Log In
                </MudButton>
                <MudButton
                    StartIcon="@Icons.Material.Filled.AppRegistration"
                    Color="Color.Primary"
                    Href="/account/register"
                    Class="ml-3">
                    Register
                </MudButton>
            </NotAuthorized>
            <Authorized>
                <MudMenu
                    AnchorOrigin="Origin.BottomCenter"
                    TransformOrigin="Origin.BottomLeft"
                    ActivationEvent="MouseEvent.LeftClick">
                    <ActivatorContent>
                        @if (notificationsCount == 0)
                        {
                            <MudAvatar>
                                <MudImage Alt="avatar"
                                          Src="@(Configuration["Configuration:General:DefaultValues:DefaultAvatar"]!)"/>
                            </MudAvatar>
                        }
                        else
                        {
                            <MudBadge Style="margin-top:6px"
                                      Max="99" @bind-content="notificationsCount"
                                      Overlap="true"
                                      Color="Color.Secondary">
                                <MudAvatar>
                                    <MudImage Alt="avatar"
                                              Src="@(Configuration["Configuration:General:DefaultValues:DefaultAvatar"]!)"/>
                                </MudAvatar>
                            </MudBadge>
                        }
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem>
                            <MudButton
                                StartIcon="@Icons.Material.Filled.ManageAccounts"
                                Color="Color.Primary"
                                Href="/profile">
                                Profile
                            </MudButton>
                        </MudMenuItem>
                        <MudDivider/>
                        <MudMenuItem>
                            <MudButton
                                StartIcon="@Icons.Material.Filled.Logout"
                                Color="Color.Primary"
                                OnClick="async () => await LogoutClick()">
                                Log Out
                            </MudButton>
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
        </AuthorizeView>
    </MudAppBar>
    <MudDrawer
        @bind-Open="drawerOpen"
        ClipMode="DrawerClipMode.Always"
        Elevation="2">
        <NavigationMenu/>
    </MudDrawer>
    <MudMainContent>
        <MudContainer
            MaxWidth="MaxWidth.ExtraLarge"
            Class="py-5 position-relative">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool drawerOpen = true;
    private int notificationsCount = 0;

    void DrawerToggle()
    {
        drawerOpen = !drawerOpen;
    }

    protected override async Task OnInitializedAsync()
    {
        NotificationsStateContainer.OnNotificationsChanged +=  NotificationCountChanged;
    }

    private async Task LogoutClick()
    {
        await (AuthenticationState as JwtAuthenticationStateProvider)!.LogOutAsync();
        Snackbar.Add("Successfully logged out.", Severity.Success);
        NavigationManager.NavigateTo("/account/login");
    }

    private async Task NotificationCountChanged()
    {
        notificationsCount = await NotificationService.GetNotificationsCountAsync();
        StateHasChanged();
    }

    public void Dispose()
    {
        NotificationsStateContainer.OnNotificationsChanged -= NotificationCountChanged;
    }

}