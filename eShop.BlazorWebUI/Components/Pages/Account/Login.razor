@page "/account/login"

@using eShop.Infrastructure.Security
@using AuthenticationManager = eShop.Infrastructure.Security.AuthenticationManager
@using LoginValidator = eShop.BlazorWebUI.Validation.LoginValidator
@inherits PageBase

@inject ISecurityService SecurityService
@inject AuthenticationManager AuthenticationManager
@inject LoginValidator Validator
@inject IConfiguration Configuration

<Title Text="Login"/>

<MudGrid Justify="Justify.Center">
    <MudItem xs="12" sm="10" md="8" lg="6" xl="4" Style="margin-top: 150px">
        <MudPaper Outlined Class="pa-3" Style="margin-bottom: 10px">
            <MudText Align="Align.Center" Typo="Typo.h4">
                Log in
            </MudText>
        </MudPaper>
        <MudPaper Outlined Class="pa-3">
            <MudForm @ref="form" Model="Model" Validation="Validator.ValidateValue">
                <MudTextField
                    @bind-Value="Model.Email"
                    For="(() => Model.Email)"
                    InputType="InputType.Email"
                    Label="Email"
                    Immediate
                    Variant="Variant.Outlined"/>
                <MudPasswordField
                    PasswordMode="true"
                    @bind-Value="Model.Password"
                    For="(() => Model.Password)"
                    Label="Password"
                    Immediate
                    Variant="Variant.Outlined"/>

                <MudLoadingButton
                    LoadingAdornment="Adornment.End" 
                    ButtonType="ButtonType.Button"
                    OnClick="async () => await OnSubmitAsync()"
                    StartIcon="@Icons.Material.Filled.Login"
                    Disabled="@(string.IsNullOrEmpty(Model.Password) || string.IsNullOrEmpty(Model.Email))"
                    Variant="Variant.Filled" 
                    Color="Color.Primary" 
                    Class="mt-3"
                    FullWidth="true">
                    Log In
                </MudLoadingButton>
            </MudForm>
        </MudPaper>
        <MudPaper Outlined Class="mt-3 pa-3">
            <MudGrid Spacing="1">
                <MudItem xs="6">
                    <MudButton 
                        ButtonType="ButtonType.Button" 
                        StartIcon="@Icons.Custom.Brands.Google"
                        Variant="Variant.Filled" 
                        OnClick="@(() => ExternalLogin("Google"))"
                        Color="Color.Primary" 
                        FullWidth="true">
                        Google
                    </MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton 
                        ButtonType="ButtonType.Button" 
                        StartIcon="@Icons.Custom.Brands.Facebook"
                        Variant="Variant.Filled" 
                        OnClick="@(() => ExternalLogin("Facebook"))"
                        Color="Color.Primary" 
                        FullWidth="true">
                        Facebook
                    </MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton 
                        ButtonType="ButtonType.Button" 
                        StartIcon="@Icons.Custom.Brands.Microsoft"
                        Variant="Variant.Filled" 
                        OnClick="@(() => ExternalLogin("Microsoft"))"
                        Color="Color.Primary" 
                        FullWidth="true">
                        Microsoft
                    </MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton 
                        ButtonType="ButtonType.Button" 
                        StartIcon="@Icons.Custom.Brands.Twitter"
                        Variant="Variant.Filled" 
                        OnClick="@(() => ExternalLogin("Twitter"))"
                        Color="Color.Primary" 
                        FullWidth="true">
                        Twitter
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
        <MudPaper Outlined Class="mt-3 pa-3">
            <MudText Align="Align.Center">
                Do not have an account?
                <MudLink Href="account/register">Register</MudLink>
            </MudText>
        </MudPaper>
        <MudPaper Outlined Class="mt-3 pa-3">
            <MudText Align="Align.Center">
                Forget your password?
                <MudLink Href="account/reset-password">Reset password</MudLink>
            </MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromQuery(Name = "returnUri")] public string ReturnUri { get; set; } = string.Empty;
    [SupplyParameterFromForm] private LoginModel Model { get; set; } = new();

    private MudForm form = new();

    private async Task OnSubmitAsync()
    {
        var request = Mapper.Map(Model);
        var result = await SecurityService.LoginAsync(request);

        if (result.Success)
        {
            var data = result.Get<LoginResponse>()!;

            if (data!.HasTwoFactorAuthentication)
            {
                Snackbar.Add(result.Message, Severity.Success);
                NavigationManager.NavigateTo($"/account/two-factor-login/{Model.Email}");
            }
            else
            {
                await AuthenticationManager.LogInAsync(data!.AccessToken, data.RefreshToken);
                NavigationManager.NavigateTo((string.IsNullOrEmpty(ReturnUri) ? "products" : ReturnUri));
                Snackbar.Add(result.Message, Severity.Success);
                Model = new();
            }
        }
        else
            Snackbar.Add(result.Message, Severity.Error);
    }

    private void ExternalLogin(string providerName)
    {
        var gatewayUri = Configuration["Configuration:Services:Proxy:Gateway:Uri"]!;
        var returnUri = NavigationManager.BaseUri + "account/confirm-external-login";
        var authUrl = $"{gatewayUri}/api/v1/Security/external-login/{providerName}?returnUri={returnUri}";
        NavigationManager.NavigateTo(authUrl);
    }

}
