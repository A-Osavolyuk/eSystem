@page "/account/register"
@using eShop.BlazorWebUI.Validation
@using eShop.Domain.Requests.API.Auth
@inherits PageBase

@inject ISecurityService SecurityService
@inject RegistrationValidator Validator

<Title Text="Register"/>

<MudGrid Justify="Justify.Center">
    <MudItem xs="12" sm="10" md="8" lg="6" xl="4" Style="margin-top: 150px">
        <MudPaper Outlined Class="pa-3" Style="margin-bottom: 10px">
            <MudText Align="Align.Center" Typo="Typo.h4">
                Register
            </MudText>
        </MudPaper>
        <MudPaper Outlined Class="pa-3">
            <MudForm Model="Model" @ref="form" Validation="Validator.ValidateValue">
                <MudTextField
                    @bind-Value="Model.Email"
                    For="(() => Model.Email)"
                    InputType="InputType.Email"
                    Label="Email"
                    Immediate
                    Variant="Variant.Outlined"/>
                <MudPasswordField
                    PasswordMode="true"
                    @bind-Value="Model.Password"
                    For="(() => Model.Password)"
                    Label="Password"
                    InputType="InputType.Password"
                    Immediate
                    Variant="Variant.Outlined"/>
                <MudPasswordField
                    PasswordMode="true"
                    @bind-Value="Model.ConfirmPassword"
                    For="(() => Model.ConfirmPassword)"
                    Label="Confirm Password"
                    InputType="InputType.Password"
                    Immediate
                    Variant="Variant.Outlined"/>

                <MudLoadingButton
                    ButtonType="ButtonType.Button"
                    StartIcon="@Icons.Material.Filled.AppRegistration"
                    Disabled="form.IsValid"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Class="mt-3"
                    FullWidth
                    OnClick="async () => await RegisterUserAsync()">
                    Register
                </MudLoadingButton>

            </MudForm>
        </MudPaper>
        <MudPaper Outlined Class="mt-3 pa-3">
            <MudText Align="Align.Center">Already have an account?
                <MudLink Href="account/login">Log In</MudLink>
            </MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromForm] private RegisterModel Model { get; set; } = new();

    private MudForm form = new();

    private async Task RegisterUserAsync()
    {
        var request = Mapper.Map(Model);
        var result = await SecurityService.RegisterAsync(request);

        if (result.Success)
        {
            Snackbar.Add(result.Message, Severity.Success);
            NavigationManager.NavigateTo($"/account/verify-email?email={Model.Email}");
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }

        Model = new();
    }


}
