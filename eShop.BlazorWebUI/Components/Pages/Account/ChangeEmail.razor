@page "/account/change-email/"
@using eShop.Infrastructure.Security
@using eShop.Domain.Requests.API.Auth

@inject ISecurityService SecurityService
@inject NavigationManager NavigationManager
@inject JwtAuthenticationStateProvider AuthenticationState
@inject ITokenProvider TokenProvider
@inject ISnackbar Snackbar

@code {
    [SupplyParameterFromQuery(Name = "currentEmail")] public string CurrentEmail { get; set; } = string.Empty;
    [SupplyParameterFromQuery(Name = "newEmail")] public string NewEmail { get; set; } = string.Empty;
    [SupplyParameterFromQuery(Name = "token")] public string Token { get; set; } = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var request = new ConfirmChangeEmailRequest()
        {
            CurrentEmail = CurrentEmail,
            NewEmail = NewEmail,
            CodeSet = new CodeSet()
        };

        var result = await SecurityService.ConfirmChangeEmailAsync(request);

        if (result.Success)
        {
            await AuthenticationState.LogOutAsync();
            Snackbar.Add(result.Message, Severity.Success);
            NavigationManager.NavigateTo("/account/login");
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
            NavigationManager.NavigateTo("/profile");
        }
    }
}
