@using eSecurity.Common.DTOs
@using eSecurity.Common.Responses
@using eSecurity.Features.TwoFactor.Commands
@using eSecurity.Security.Authentication.TwoFactor

@inject UserState UserState
@inject ISnackbar Snackbar
@inject ISender Sender

<MudStack Spacing="4">
    <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
        Enter one of the 16 recovery codes saved during 2FA configuration.
    </MudTextM3>
    <MudForm @ref="form" Model="Model">
        <MudTextFieldExtended
            Mask="mask"
            Placeholder="XXXXXXXXXX"
            Variant="Variant.Outlined"
            Margin="Margin.Dense"
            Clearable="true"
            Immediate="true"
            @bind-Value="Model.Code"
            For="() => Model.Code"/>
    </MudForm>
    <MudStack Spacing="2">
        <MudButton
            Size="Size.Medium"
            Color="Color.Success"
            Variant="Variant.Filled"
            ButtonType="ButtonType.Button"
            Disabled="@(Model.Code.Length < 9)"
            OnClick="@(async () => await OnSignInAsync())">
            Verify
        </MudButton>
        <MudButton
            Color="Color.Default"
            Variant="Variant.Outlined"
            ButtonType="ButtonType.Button"
            Size="Size.Medium"
            OnClick="@(() => Expand())"
            EndIcon="@GetIcon()">
            More options
        </MudButton>
        <MudCollapse Expanded="expanded">
            <MudDivider Class="my-2"/>
            <MudStack Spacing="2">
                @if (Methods.Any(x => x.Method == TwoFactorMethod.Passkey))
                {
                    <MudButton
                        Color="Color.Default"
                        Variant="Variant.Outlined"
                        ButtonType="ButtonType.Button"
                        Size="Size.Medium"
                        OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Passkey))">
                        Passkey
                    </MudButton>
                }
                @if (Methods.Any(x => x.Method == TwoFactorMethod.AuthenticatorApp))
                {
                    <MudButton
                        Color="Color.Default"
                        Variant="Variant.Outlined"
                        ButtonType="ButtonType.Button"
                        Size="Size.Medium"
                        OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.AuthenticatorApp))">
                        Authenticator app
                    </MudButton>
                }
                @if (Methods.Any(x => x.Method == TwoFactorMethod.Sms))
                {
                    <MudButton
                        Color="Color.Default"
                        Variant="Variant.Outlined"
                        ButtonType="ButtonType.Button"
                        Size="Size.Medium"
                        OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Sms))">
                        SMS
                    </MudButton>
                }
            </MudStack>
        </MudCollapse>
    </MudStack>
</MudStack>

@code {
    [Parameter] 
    public EventCallback<TwoFactorMethod> OnChangeMethod { get; set; }
    
    [Parameter] 
    public EventCallback OnSignIn { get; set; }
    
    [Parameter] 
    public List<UserTwoFactorMethod> Methods { get; set; } = [];
    
    [SupplyParameterFromQuery(Name = "id")]
    public Guid UserId { get; set; }

    [SupplyParameterFromQuery(Name = "return_url")]
    public string ReturnUrl { get; set; } = string.Empty;
    
    [SupplyParameterFromForm] 
    public CodeModel Model { get; set; } = new();
    
    private MudForm form = new();
    private readonly PatternMask mask = new("**********");
    private bool expanded;

    private async Task OnSignInAsync()
    {
        await form.Validate();

        if (form.IsValid)
        {
            var command = new VerifyRecoveryCodeCommand()
            {
                UserId = UserId,
                Code = Model.Code
            };

            var result = await Sender.Send(command);

            if (result.Succeeded)
            {
                var response = result.Get<VerifyRecoveryCodeResponse>()!;

                UserState.UserId = response.UserId;
                await OnSignIn.InvokeAsync();
            }
            else Snackbar.Add(result.Message, Severity.Error);
        }
    }
    
    private void Expand() => expanded = !expanded;
    private string GetIcon() => expanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore;
}