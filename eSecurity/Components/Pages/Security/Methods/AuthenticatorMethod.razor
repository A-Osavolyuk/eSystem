@using eSecurity.Common.DTOs
@using eSecurity.Security.Authentication.TwoFactor
@inject ConfirmationManager ConfirmationManager
@inject IDialogService DialogService

<MudStack Row="true" Class="px-5">
    <MudIcon Icon="@Icons.Material.Outlined.Smartphone" Size="Size.Medium" Class="mt-1"/>
    <MudStack Spacing="0">
        <MudStack Row="true" Spacing="1">
            <MudTextM3 Typo="TypoM3.Title" Size="Size.Medium" Class="fw-bold pt-1">
                Authenticator app
            </MudTextM3>
            @if (Model.AuthenticatorEnabled)
            {
                <MudChip
                    T="string"
                    Class="mx-0"
                    Size="Size.Small"
                    Color="Color.Success"
                    Variant="Variant.Outlined">
                    Configured
                </MudChip>
            }
            else
            {
                <MudChip
                    T="string"
                    Class="mx-0"
                    Size="Size.Small"
                    Color="Color.Error"
                    Variant="Variant.Outlined">
                    Not configured
                </MudChip>
            }
            @if (Model.PreferredMethod == TwoFactorMethod.AuthenticatorApp)
            {
                <MudChip
                    T="string"
                    Class="mx-0"
                    Size="Size.Small"
                    Color="Color.Info"
                    Variant="Variant.Outlined">
                    Preferred
                </MudChip>
            }
        </MudStack>
        @if (showConfiguration)
        {
            <AuthenticatorAppConfiguration OnClose="@(() => ToggleConfiguration())"/>
        }
        else
        {
            <MudTextM3 Typo="TypoM3.Body" Size="Size.Small" Class="opacity-50">
                Use an authentication app or browser extension
                to get two-factor authentication codes when prompted.
            </MudTextM3>
        }
    </MudStack>
    <MudSpacer/>
    <MudStack>
        <MudButton
            ButtonType="ButtonType.Button"
            Variant="Variant.Outlined"
            Size="Size.Small"
            OnClick="@(async () => await ShowAsync())"
            Disabled="showConfiguration">
            Edit
        </MudButton>
    </MudStack>
</MudStack>

@code {
    [Parameter] public TwoFactorData Model { get; set; } = new();

    private bool showConfiguration;

    private async Task ShowAsync()
    {
        var confirmationResult = await ConfirmationManager.InitiateAsync(
            PurposeType.AuthenticatorApp, ActionType.Reconfigure);
        
        if (!confirmationResult!.Canceled) ToggleConfiguration();
    }

    private void ToggleConfiguration() => showConfiguration = !showConfiguration;
}