@page "/account/oauth/sign-in/"

@using eSecurity.Common.Responses
@using eSecurity.Features.LinkedAccounts.Commands
@using eSystem.Core.Security.Authorization.OAuth

@inherits PageBase


<Title Text="Sign in via OAuth" />

<MudGrid Justify="Justify.Center">
    <MudItem xs="4" Style="margin-top: 150px">
        <MudLoading Loading="true" LoaderType="LoaderType.Circular" Text="Processing OAuth session..."></MudLoading>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromQuery(Name = "sessionId")] public string SessionId { get; set; } = string.Empty;
    [SupplyParameterFromQuery(Name = "token")] public string Token { get; set; } = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var command = new LoadSessionCommand()
            {
                Id = Guid.Parse(SessionId),
                Token = Token
            };

            var result = await Sender.Send(command);

            if (result.Succeeded)
            {
                var response = result.Get<LoadOAuthSessionResponse>()!;
                
                UserState.UserId = response.UserId;
                await AuthenticationManager.SignInAsync();
                
                //TODO: Handle different OAuth sign types

                if (response.SignType == OAuthSignType.SignIn)
                {
                    Snackbar.Add($"Successfully signed in with {response.LinkedAccount}", Severity.Success);
                    NavigationManager.NavigateTo(Links.Account.Profile);
                }
                else
                {
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Account.OAuthSignedUpPage)
                        .WithQueryParam("provider", response.LinkedAccount);
                    
                    NavigationManager.NavigateTo(builder.Build());
                }
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Success);
            }
        }
    }
}
