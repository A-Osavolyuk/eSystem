@page "/connect/logout"

@using System.Text.Json
@using eSecurity.Features.ODIC.Commands
@using eSecurity.Security.Authentication.Odic.Session
@using eSecurity.Security.Cookies
@using eSystem.Core.Security.Cookies
@using eSystem.Core.Security.Cryptography.Protection
@inherits PageBase

@attribute [Authorize]

@inject ICookieAccessor CookieAccessor
@inject IProtectorFactory ProtectorFactory

<MudGrid Justify="Justify.Center">
    <MudItem xs="3" Style="margin-top: 50px;">
        <MudStack Spacing="2">
            <MudPaper Outlined="true" Class="px-5 py-4">
                <MudGrid>
                    <MudItem xs="1">
                        <MudAvatar Size="Size.Medium">
                            <MudImage
                                Src="/images/avatar.jpg"
                                Alt="Avatar"
                                FallbackSrc="/images/avatar.jpg"/>
                        </MudAvatar>
                    </MudItem>
                    <MudItem xs="10">
                        <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
                            <MudTextM3 Class="pt-2">
                                Signed-in as <strong>@UserState.Credentials?.Username</strong>
                            </MudTextM3>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            <MudButton
                Size="Size.Large"
                Color="Color.Error"
                Variant="Variant.Outlined"
                ButtonType="ButtonType.Button"
                OnClick="@(async () => await OnSignOutAsync())">
                Sign out
            </MudButton>
        </MudStack>
    </MudItem>
</MudGrid>

@code {

    private async Task OnSignOutAsync()
    {
        var protector = ProtectorFactory.Create(ProtectionPurposes.Session);
        var sessionCookie = CookieAccessor.Get(DefaultCookies.Session)!;
        var unprotectedCookie = protector.Unprotect(sessionCookie);
        var session = JsonSerializer.Deserialize<SessionCookie>(unprotectedCookie)!;
        
        var command = new LogoutCommand() { SessionId = session.SessionId };
        var result = await Sender.Send(command);

        if (result.Succeeded) await AuthenticationManager.SignOutAsync();
        else Snackbar.Add(result.Message, Severity.Error);
    }
}