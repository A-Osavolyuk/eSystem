@page "/account/register"
@using eShop.Blazor.Application.Mapping
@using eShop.Blazor.Application.Validation
@using eShop.Blazor.Domain.Interfaces
@using eShop.Blazor.Domain.Models
@inherits PageBase

@inject ISecurityService SecurityService
@inject RegistrationValidator Validator

<Title Text="Register"/>

<MudGrid Justify="Justify.Center">
    <MudItem xs="12" sm="10" md="8" lg="6" xl="4" Style="margin-top: 150px">
        <MudStack Spacing="1" Justify="Justify.Center">
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center" Typo="Typo.h4">
                    Register
                </MudText>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudForm
                    @ref="form"
                    Model="Model"
                    Validation="Validator.ValidateValue">
                    <MudTextField
                        @bind-Value="Model.Email"
                        For="(() => Model.Email)"
                        InputType="InputType.Email"
                        Label="Email"
                        Immediate
                        Variant="Variant.Outlined"/>
                    <MudTextField
                        @bind-Value="Model.UserName"
                        For="(() => Model.UserName)"
                        InputType="InputType.Email"
                        Label="Username"
                        Immediate
                        Variant="Variant.Outlined"/>
                    <MudPasswordField
                        PasswordMode="true"
                        @bind-Value="Model.Password"
                        For="(() => Model.Password)"
                        Label="Password"
                        InputType="InputType.Password"
                        Immediate
                        Variant="Variant.Outlined"/>
                    <MudPasswordField
                        PasswordMode="true"
                        @bind-Value="Model.ConfirmPassword"
                        For="(() => Model.ConfirmPassword)"
                        Label="Confirm Password"
                        InputType="InputType.Password"
                        Immediate
                        Variant="Variant.Outlined"/>

                    <MudLoadingButton
                        ButtonType="ButtonType.Button"
                        StartIcon="@Icons.Material.Filled.AppRegistration"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        Class="mt-3"
                        FullWidth
                        OnClick="@(async () => await OnRegisterAsync())">
                        Register
                    </MudLoadingButton>
                </MudForm>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center">Already have an account?
                    <MudLink OnClick="@(() => RouteManager.Route("/account/login"))">
                        Log In
                    </MudLink>
                </MudText>
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromForm] private RegisterModel Model { get; set; } = new();

    private MudForm form = new();

    private async Task OnRegisterAsync()
    {
        await form.Validate();

        if (form.IsValid)
        {
            var request = Mapper.Map(Model);
            var result = await SecurityService.RegisterAsync(request);

            if (result.Success)
            {
                var response = result.Get<RegistrationResponse>()!;

                Snackbar.Add(result.Message, Severity.Success);
                RouteManager.Route($"/account/email/verify?id={response.UserId}&email={Model.Email}");
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
    }


}
