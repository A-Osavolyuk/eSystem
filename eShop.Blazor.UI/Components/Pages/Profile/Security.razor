@page "/account/security"

@using eShop.Blazor.UI.Components.Pages.Profile.Components.Security

@inherits PageBase

@inject IUserService UserService
@inject IDialogService DialogService

@attribute [Authorize]

<Title Text="Password and authentication"></Title>

@if (SecurityModel is not null)
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="6">
            <MudStack Spacing="2" Justify="Justify.Center">
                <PasswordSection
                    Model="SecurityModel"
                    OnAdd="@(() => OnAddPasswordAsync())"
                    OnChange="@(() => OnChangePasswordAsync())"
                    OnReset="@(() => OnResetPasswordAsync())"/>
                <PasskeysSection
                    Model="SecurityModel"
                    OnCreate="@(() => OnCreatePasskeyAsync())"
                    OnRemove="@((value) => OnPasskeyRemoveAsync(value))"/>
                <LinkedAccountsSection
                    Model="SecurityModel"
                    OnAllow="@((value) => OnAllowLinkedAccountAsync(value))"
                    OnDisallow="@((value) => OnDisallowLinkedAccountAsync(value))"
                    OnDisconnect="@((value) => OnDisconnectLinkedAccountAsync(value))"/>
                <TwoFactorSection
                    Model="SecurityModel"
                    OnSubscribe="@((value) => OnSubscribe(value))"
                    OnUnsubscribe="@((value) => OnUnsubscribe(value))"/>
                <RecoveryEmailSection
                    Model="SecurityModel"
                    OnAdd="@(() => OnAddRecoveryEmailAsync())"
                    OnChange="@(() => OnChangeRecoveryEmailAsync())"
                    OnRemove="@(() => OnRemoveRecoveryEmailAsync())"
                    OnVerify="@(() => OnVerifyRecoveryEmailAsync())"/>
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {
    private UserSecurityModel? SecurityModel { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task LoadAsync()
    {
        var result = await UserService.GetUserSecurityDataAsync(UserState.UserId);

        if (result.Success)
        {
            var response = result.Get<UserSecurityDto>()!;

            SecurityModel = Mapper.Map(response);
            await UserState.Change();
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }
    }

    private async Task OnCreatePasskeyAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new CreatePasskeyModel() { UserId = UserState.UserId };

        var parameters = new DialogParameters<CreatePasskeyDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<CreatePasskeyDialog>("Create passkey", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnChangePasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new ChangePasswordModel() { Id = UserState.UserId };

        var parameters = new DialogParameters<ChangePasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>("Change password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnAddPasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new AddPasswordModel() { UserId = UserState.UserId };

        var parameters = new DialogParameters<AddPasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<AddPasswordDialog>("Add password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private void OnResetPasswordAsync()
    {
        RouteManager.Route("/account/password/reset");
    }

    private void OnSubscribe(string provider)
    {
        if (provider == ProviderTypes.Authenticator) RouteManager.Route("/account/2fa/authenticator/enable");
        else RouteManager.Route($"/account/2fa/provider/enable?provider={provider}");
    }

    private void OnUnsubscribe(string provider)
    {
        RouteManager.Route($"/account/2fa/provider/disable?provider={provider}");
    }

    private void OnRemoveRecoveryEmailAsync()
    {
        var url = $"/account/recovery-email/remove";
        RouteManager.Route(url);
    }

    private void OnChangeRecoveryEmailAsync()
    {
        var url = $"/account/recovery-email/change";
        RouteManager.Route(url);
    }

    private void OnVerifyRecoveryEmailAsync()
    {
        var url = $"/account/recovery-email/verify";
        RouteManager.Route(url);
    }

    private void OnAddRecoveryEmailAsync()
    {
        var url = "/account/recovery-email/add";
        RouteManager.Route(url);
    }

    private void OnPasskeyRemoveAsync(Guid id)
    {
        var url = $"/account/passkey/remove?passkey={id}";
        RouteManager.Route(url);
    }

    private void OnDisconnectLinkedAccountAsync(string provider)
    {
        var url = $"/account/linked-account/disconnect?provider={provider}";
        RouteManager.Route(url);
    }

    private void OnAllowLinkedAccountAsync(string provider)
    {
        var url = $"/account/linked-account/allow?provider={provider}";
        RouteManager.Route(url);
    }

    private void OnDisallowLinkedAccountAsync(string provider)
    {
        var url = $"/account/linked-account/disallow?provider={provider}";
        RouteManager.Route(url);
    }
}