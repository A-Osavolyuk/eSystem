@using eShop.Blazor.Application.State
@using eShop.Blazor.Domain.Interfaces
@using eShop.Blazor.Infrastructure.Security
@using Router = eShop.Blazor.Application.Routing.RouteManager
@using Size = MudBlazor.Size

@inject AuthenticationManager AuthenticationManager
@inject Router RouteManager
@inject UserState UserState
@inject ISnackbar Snackbar
@inject IUserService UserService
@inject IStorage Storage

@implements IDisposable

<MudAvatar @onclick="DrawerToggle">
    <MudImage
        Src="/images/avatar.jpg"
        Alt="Avatar"
        FallbackSrc="/images/avatar.jpg"/>
</MudAvatar>
<MudDrawer Class="py-3"
           @bind-Open="isDrawerOpen"
           ClipMode="DrawerClipMode.Never"
           Overlay="true"
           Anchor="Anchor.End"
           Variant="DrawerVariant.Temporary"
           Width="300px"
           Elevation="2">
    <MudDrawerHeader Class="w-100">
        <MudStack Class="w-100">
            <MudStack Row="true" Justify="Justify.Center">
                <MudAvatar Size="Size.Large">
                    <MudImage
                        Src="/images/avatar.jpg"
                        Alt="Avatar"
                        FallbackSrc="/images/avatar.jpg"/>

                </MudAvatar>
            </MudStack>
            @if (!string.IsNullOrEmpty(UserState.Credentials?.Username))
            {
                <MudText Inline="true" Align="Align.Center"> @UserState.Credentials!.Username </MudText>
            }
            <MudDivider/>
        </MudStack>
    </MudDrawerHeader>
    <MudNavMenu Color="Color.Primary" Class="px-3">
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/profile"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.AccountBox">
            Profile
        </MudNavLink>
        <MudDivider Class="my-2" />
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/security"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Security">
            Password and authentication
        </MudNavLink>
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/devices"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Devices">
            Devices
        </MudNavLink>
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/emails"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Email">
            Emails
        </MudNavLink>
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/phone-numbers"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Smartphone">
            Phone numbers
        </MudNavLink>
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/recovery"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Autorenew">
            Account recovery
        </MudNavLink>
        <MudDivider Class="my-2" />
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/orders"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.ShoppingCart">
            Orders
        </MudNavLink>
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/orders-history"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.History">
            Order History
        </MudNavLink>
        <MudNavLink
            OnClick="@(() => NavigateAsync("/account/settings"))"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Settings">
            Settings
        </MudNavLink>
        <MudDivider Class="my-2"/>
        <MudNavLink
            Match="NavLinkMatch.All"
            OnClick="@(async () => await LogoutClick())"
            Icon="@Icons.Material.Filled.Logout">
            Logout
        </MudNavLink>
    </MudNavMenu>
</MudDrawer>

@code {
    private bool isDrawerOpen = false;

    protected override void OnInitialized()
    {
        UserState.OnChange += ReloadAsync;
    }

    private async Task ReloadAsync()
    {
        await LoadAsync();
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task LogoutClick()
    {
        await AuthenticationManager.SignOutAsync();
        Snackbar.Add("Successfully logged out.", Severity.Success);
    }

    private async Task LoadAsync()
    {
        var userId = await Storage.GetAsync<Guid>("userId");
        var result = await UserService.GetUserStateAsync(userId);

        if (result.Success)
        {
            var user = result.Get<UserStateDto>()!;
            UserState.Map(user);
        }
    }

    private void DrawerToggle() => isDrawerOpen = !isDrawerOpen;

    private void NavigateAsync(string uri)
    {
        RouteManager.Route(uri);
        DrawerToggle();
    }

    public void Dispose()
    {
        UserState.OnChange -= ReloadAsync;
    }

}