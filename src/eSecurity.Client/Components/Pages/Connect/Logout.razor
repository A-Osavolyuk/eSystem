@page "/connect/logout"

@using eSecurity.Client.Security.Authentication.Oidc
@using eSecurity.Client.Security.Authentication.Oidc.Clients
@using eSecurity.Client.Security.Authentication.Oidc.Token

@inherits PageBase

@attribute [Authorize]

@inject IConnectService ConnectService
@inject IOptions<ClientOptions> ClientOptions
@inject TokenProvider TokenProvider

<Title Text="Logout from eSystem Account"></Title>

<MudGrid Justify="Justify.Center">
    <MudItem xs="3" Style="margin-top: 50px;">
        <MudStack Spacing="2">
            <MudPaper Outlined="true" Class="px-5 py-4">
                <MudGrid>
                    <MudItem xs="1">
                        <MudAvatar Size="Size.Medium">
                            <MudImage
                                Src="/images/avatar.jpg"
                                Alt="Avatar"
                                FallbackSrc="/images/avatar.jpg"/>
                        </MudAvatar>
                    </MudItem>
                    <MudItem xs="10">
                        <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
                            <MudTextM3 Class="pt-2">
                                Signed-in as <strong>@UserState.Credentials?.Username</strong>
                            </MudTextM3>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            <MudButton
                Size="Size.Large"
                Color="Color.Error"
                Variant="Variant.Outlined"
                ButtonType="ButtonType.Button"
                OnClick="@(async () => await LogoutAsync())">
                Sign out
            </MudButton>
        </MudStack>
    </MudItem>
</MudGrid>

@code {

    [SupplyParameterFromQuery(Name = "id_token_hint")]
    public string IdTokenHint { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "post_logout_redirect_uri")]
    public string PostLogoutRedirectUri { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "state")]
    public string State { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "client_id")]
    public string? ClientId { get; set; }

    [SupplyParameterFromQuery(Name = "logout_hint")]
    public string? LogoutHint { get; set; }

    [SupplyParameterFromQuery(Name = "ui_locales")]
    public string? UiLocales { get; set; }

    private async Task LogoutAsync()
    {
        LogoutRequest? request;
        if (string.IsNullOrEmpty(IdTokenHint) && string.IsNullOrEmpty(PostLogoutRedirectUri))
        {
            var options = ClientOptions.Value;
            request = new LogoutRequest()
            {
                ClientId = options.ClientId,
                IdTokenHint = TokenProvider.IdToken!,
                PostLogoutRedirectUri = options.PostLogoutRedirectUri,
                State = Guid.CreateVersion7().ToString(),
            };
        }
        else
        {
            request = new LogoutRequest()
            {
                ClientId = ClientId,
                IdTokenHint = IdTokenHint,
                PostLogoutRedirectUri = PostLogoutRedirectUri,
                State = State,
            };
        }

        var result = await ConnectService.LogoutAsync(request);

        if (result.Succeeded)
        {
            await AuthenticationManager.LogoutAsync();

            var response = result.Get();
            NavigationContext.Value = response.FrontChannelLogoutUris;
            NavigationManager.NavigateTo(QueryBuilder.Create()
                .WithUri(response.PostLogoutRedirectUri)
                .WithQueryParam("state", response.State)
                .Build());
        }
    }
}