@page "/settings/reset-password"

@using eSecurity.Client.Security.Authentication.Password
@inherits PageBase

@attribute [Authorize]

@inject ResetPasswordValidator Validator
@inject IPasswordService PasswordService

<Title Text="Password reset"></Title>

<AccessConfirmation Context="_context">
    <AccessConfirmed>
        <MudGrid Justify="Justify.Center">
            <MudItem xs="3" Style="margin-top: 50px">
                <MudPaper Outlined="true" Class="pa-10">
                    <MudStack Spacing="3">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Style="font-size: 5rem" Icon="@Icons.Material.Filled.LockReset"/>
                        </MudStack>
                        <MudTextM3 Align="Align.Center" Typo="TypoM3.Headline" Size="Size.Small">
                            Password reset
                        </MudTextM3>
                        <MudForm
                            @ref="_form"
                            Model="_model"
                            Validation="Validator.ValidateValue">
                            <MudPasswordField
                                @bind-Value="_model.NewPassword"
                                For="() => _model.NewPassword"
                                Label="New password"
                                Variant="Variant.Outlined"
                                Immediate="true"
                                Clearable="true"/>
                            <MudPasswordField
                                @bind-Value="_model.ConfirmNewPassword"
                                For="() => _model.ConfirmNewPassword"
                                Label="Confirm new password"
                                Variant="Variant.Outlined"
                                Immediate="true"
                                Clearable="true"/>
                        </MudForm>
                        <MudStack Spacing="2">
                            <MudLoadingButton
                                Color="Color.Primary"
                                Variant="Variant.Filled"
                                ButtonType="ButtonType.Button"
                                Size="Size.Large"
                                OnClick="@(async () => await OnResetAsync())">
                                Confirm
                            </MudLoadingButton>
                            <MudButton
                                Color="Color.Info"
                                Variant="Variant.Text"
                                ButtonType="ButtonType.Button"
                                Size="Size.Large"
                                OnClick="@(() => NavigationManager.NavigateTo(ReturnUrl))"
                                Href="@ReturnUrl">
                                Cancel
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </AccessConfirmed>
</AccessConfirmation>

@code {

    [SupplyParameterFromQuery(Name = "return_url")]
    public string ReturnUrl { get; set; } = null!;

    private readonly ResetPasswordModel _model = new();

    private MudForm _form = new();
    private ConfirmationContext? _context;

    protected override void OnInitialized()
    {
        _context = new ConfirmationContext
        {
            Purpose = PurposeType.Password,
            Action = ActionType.Reset,
        };
    }

    private async Task OnResetAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new ResetPasswordRequest
            {
                UserId = UserState.UserId,
                NewPassword = _model.NewPassword
            };

            var result = await PasswordService.ResetPasswordAsync(request);

            if (result.Succeeded)
            {
                Snackbar.Add("Password was successfully reset", Severity.Success);
                NavigationManager.NavigateTo(ReturnUrl);
            }
            else Snackbar.Add(result.GetError().Description, Severity.Error);
        }
    }

}