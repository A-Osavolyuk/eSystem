@page "/oauth/sign-up"
@using eSystem.Core.Utilities.State
@using eSecurity.Client.Security.Identity

@inherits PageBase

@layout AuthenticationLayout

@inject IUsernameService UsernameService
@inject SetUsernameValidator Validator

<Title Text="OAuth sign up"/>

@if (!string.IsNullOrEmpty(_provider))
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="3" Style="margin-top: 50px">
            <MudStack Spacing="1">
                <MudPaper Elevation="4" Class="pa-10">
                    <MudStack Spacing="3">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Style="font-size: 5rem" Icon="@Icons.Material.Filled.Lock"/>
                        </MudStack>
                        <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small" Align="Align.Center">
                            Sign Up with @_provider
                        </MudTextM3>
                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
                            Now you can set your username, otherwise your email address will be used as username.
                        </MudTextM3>
                        <MudStack Spacing="1">
                            <MudForm @ref="_form" Model="_model" Validation="Validator.ValidateValue">
                                <MudTextFieldExtended
                                    Label="Username"
                                    @bind-Value="_model.Username"
                                    For="() => _model.Username"
                                    Variant="Variant.Outlined"
                                    Immediate="true"
                                    Clearable="true"
                                    Error="_showError"
                                    ErrorText="@_error"/>
                            </MudForm>
                        </MudStack>
                        <MudButton
                            Color="Color.Primary"
                            Variant="Variant.Filled"
                            ButtonType="ButtonType.Button"
                            Size="Size.Large"
                            OnClick="@(async () => await OnSetAsync())">
                            Continue
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {

    [SupplyParameterFromQuery(Name = "state")]
    public string? State { get; set; }

    private MudForm _form = new();
    private readonly SetUsernameModel _model = new();

    private string? _provider;
    private string? _authorizationState;
    private Guid _sid;

    private string? _error;
    private bool _showError;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(State))
        {
            var stateData = StateParser.Parse(State);
            if (stateData.TryGetValue("sid", out var sid))
                _sid = Guid.Parse(sid);

            if (stateData.TryGetValue("identityProvider", out var identityProvider))
                _provider = identityProvider;

            if (stateData.TryGetValue("state", out var state))
                _authorizationState = state;
        }
    }

    private async Task OnSetAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new SetUsernameRequest
            {
                Sid = _sid,
                Username = _model.Username
            };

            var result = await UsernameService.SetUsernameAsync(request);
            if (result.Succeeded)
            {
                if (!string.IsNullOrEmpty(_authorizationState))
                {
                    await AuthenticationManager.SignInAsync(_sid);
                    var stateData = StateParser.Parse(_authorizationState);
                    NavigationManager.NavigateTo(stateData["return_url"], true);
                }
                else
                {
                    NavigationManager.NavigateTo(QueryBuilder.Create()
                        .WithUri(Links.OAuth.Error)
                        .WithQueryParam("error", ErrorTypes.Common.InvalidSession)
                        .WithQueryParam("error_description", "Invalid session.")
                        .Build());
                }
            }
            else
            {
                var error = result.GetError();
                if (error.Code == ErrorTypes.Common.UsernameTaken)
                {
                    _error = "Username is already taken.";
                    _showError = true;
                }
                else
                    Snackbar.Add(error.Description, Severity.Error);
            }
        }
    }

}