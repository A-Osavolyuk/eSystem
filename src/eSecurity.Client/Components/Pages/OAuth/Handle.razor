@page "/oauth/handle"

@using eSecurity.Client.Security
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authorization.OAuth
@using eSystem.Core.Security.Authentication.OpenIdConnect.Constants
@using eSystem.Core.Utilities.State

@inherits PageBase

@layout AuthenticationLayout

@inject ISecurityService SecurityService

<Title Text="Handling OAuth session..."/>

@code {
    [SupplyParameterFromQuery(Name = "state")]
    public string State { get; set; } = string.Empty;
    
    [SupplyParameterFromQuery(Name = "sid")]
    public Guid SessionId { get; set; }

    [SupplyParameterFromQuery(Name = "error")]
    public string? ErrorCode { get; set; }

    [SupplyParameterFromQuery(Name = "error_description")]
    public string? ErrorDescription { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!string.IsNullOrEmpty(ErrorCode) && !string.IsNullOrEmpty(ErrorDescription))
        {
            NavigationManager.NavigateTo(QueryBuilder.Create()
                .WithUri(Links.OAuth.Error)
                .WithQueryParam("error", ErrorTypes.Common.InvalidSession)
                .WithQueryParam("error_description", "Invalid session.")
                .Build());

            return;
        }

        var result = await SecurityService.GetAuthenticationSessionAsync(SessionId);
        if (result.Succeeded && result.TryGetValue<AuthenticationSessionDto>(out var session) && session is not null)
        {
            var oauthState = JsonSerializer.Deserialize<OAuthState>(State)!;
            var authorizationState = StateBuilder.Create()
                .WithData("return_url", GetRedirectUri(oauthState))
                .Build();
                
            if (session.OAuthFlow == OAuthFlow.SignIn)
            {
                if (session.NextMethod == AuthenticationMethods.MultiFactorAuthentication)
                {
                    var state = StateBuilder.Create()
                        .WithData("transactionId", SessionId.ToString())
                        .WithData("state", authorizationState)
                        .Build();
                        
                    NavigationManager.NavigateTo(QueryBuilder.Create()
                        .WithUri(Links.Session.TwoFactor)
                        .WithQueryParam("state", state)
                        .Build());
                }
                else
                {
                    NavigationManager.NavigateTo(GetRedirectUri(oauthState));
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(session.IdentityProvider) && session.SessionId.HasValue)
                {
                    var state = StateBuilder.Create()
                        .WithData("sid", session.SessionId.Value.ToString())
                        .WithData("provider", session.IdentityProvider)
                        .WithData("state", authorizationState)
                        .Build();
                        
                    NavigationManager.NavigateTo(QueryBuilder.Create()
                        .WithUri(Links.Session.TwoFactor)
                        .WithQueryParam("state", state)
                        .Build());
                }
            }
        }
        else
        {
            var error = result.GetError();
            NavigationManager.NavigateTo(QueryBuilder.Create()
                .WithUri(Links.OAuth.Error)
                .WithQueryParam("error", error.Code)
                .WithQueryParam("error_description", error.Description)
                .Build());
        }
    }
    
    private string GetRedirectUri(OAuthState state)
    {
        var builder = QueryBuilder.Create().WithUri(Links.Connect.Authorize);

        if (!string.IsNullOrEmpty(state!.ResponseType))
            builder.WithQueryParam("response_type", state.ResponseType);

        if (!string.IsNullOrEmpty(state.ClientId))
            builder.WithQueryParam("client_id", state.ClientId);

        if (!string.IsNullOrEmpty(state.RedirectUri))
            builder.WithQueryParam("redirect_uri", state.RedirectUri);
        
        if (!string.IsNullOrEmpty(state.ReturnUrl))
            builder.WithQueryParam("return_url", state.ReturnUrl);

        if (!string.IsNullOrEmpty(state.Scope))
            builder.WithQueryParam("scope", state.Scope);

        if (!string.IsNullOrEmpty(state.Nonce))
            builder.WithQueryParam("nonce", state.Nonce);

        if (!string.IsNullOrEmpty(state.State))
            builder.WithQueryParam("state", state.State);

        if (!string.IsNullOrEmpty(state.Prompt))
            builder.WithQueryParam("prompt", state.Prompt);

        return builder.Build();
    }

}