@page "/oauth/handle"

@using eSecurity.Core.Security.Authorization.OAuth
@using eSystem.Core.Utilities.State

@inherits PageBase

@layout AuthenticationLayout

<Title Text="Handling OAuth session..."/>

@code {
    [SupplyParameterFromQuery(Name = "state")]
    public string State { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "error")]
    public string? ErrorCode { get; set; }

    [SupplyParameterFromQuery(Name = "error_description")]
    public string? ErrorDescription { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!string.IsNullOrEmpty(ErrorCode) && !string.IsNullOrEmpty(ErrorDescription))
        {
            NavigationManager.NavigateTo(QueryBuilder.Create()
                .WithUri(Links.OAuth.Error)
                .WithQueryParam("error", ErrorTypes.Common.InvalidSession)
                .WithQueryParam("error_description", "Invalid session.")
                .Build());
        }
        else
        {
            var stateData = StateParser.Parse(State);
            var userId = stateData["userId"];
            var flow = stateData["flow"];
            var provider = stateData["provider"];
            var stateBase64 = stateData["state"];
            var stateBytes = WebEncoders.Base64UrlDecode(stateBase64);
            var stateJson = Encoding.UTF8.GetString(stateBytes);
            var state = JsonSerializer.Deserialize<OAuthState>(stateJson);

            if (state is null)
            {
                NavigationManager.NavigateTo(QueryBuilder.Create()
                    .WithUri(Links.OAuth.Error)
                    .WithQueryParam("error", ErrorTypes.Common.InvalidSession)
                    .WithQueryParam("error_description", "Invalid session.")
                    .Build());

                return;
            }
            
            UserState.UserId = Guid.Parse(userId);
            
            if (flow == "sign-in")
            {
                var requireTwoFactor = Convert.ToBoolean(stateData["requireTwoFactor"]);
                if (requireTwoFactor)
                {
                    var stateBuilder = StateBuilder.Create()
                        .WithData("userId", userId)
                        .WithData("provider", provider)
                        .WithData("state", StateBuilder.Create()
                            .WithData("state", GetRedirectUri(state))
                            .Build());
                        
                    NavigationManager.NavigateTo(QueryBuilder.Create()
                        .WithUri(Links.Session.TwoFactor)
                        .WithQueryParam("state", stateBuilder.Build())
                        .Build());
                }
                else
                {
                    NavigationManager.NavigateTo(GetRedirectUri(state));
                }
            }
            else
            {
                var stateBuilder = StateBuilder.Create()
                    .WithData("userId", userId)
                    .WithData("provider", provider)
                    .WithData("state", StateBuilder.Create()
                        .WithData("state", GetRedirectUri(state))
                        .Build());
                        
                NavigationManager.NavigateTo(QueryBuilder.Create()
                    .WithUri(Links.OAuth.SignUp)
                    .WithQueryParam("state", stateBuilder.Build())
                    .Build());
            }
        }
    }
    
    private string GetRedirectUri(OAuthState state)
    {
        var builder = QueryBuilder.Create().WithUri(Links.Connect.Authorize);

        if (!string.IsNullOrEmpty(state!.ResponseType))
            builder.WithQueryParam("response_type", state.ResponseType);

        if (!string.IsNullOrEmpty(state.ClientId))
            builder.WithQueryParam("client_id", state.ClientId);

        if (!string.IsNullOrEmpty(state.RedirectUri))
            builder.WithQueryParam("redirect_uri", state.RedirectUri);

        if (!string.IsNullOrEmpty(state.Scope))
            builder.WithQueryParam("scope", state.Scope);

        if (!string.IsNullOrEmpty(state.Nonce))
            builder.WithQueryParam("nonce", state.Nonce);

        if (!string.IsNullOrEmpty(state.State))
            builder.WithQueryParam("state", state.State);

        if (!string.IsNullOrEmpty(state.Prompt))
            builder.WithQueryParam("prompt", state.Prompt);

        return builder.Build();
    }

}