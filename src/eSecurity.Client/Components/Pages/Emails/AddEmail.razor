@using eSecurity.Client.Security.Identity
@using eSecurity.Client.Security
@inject UserState UserState
@inject AddEmailValidator Validator
@inject ISnackbar Snackbar
@inject ISecurityService SecurityService
@inject IEmailService EmailService

<MudPaper Elevation="4" Class="pa-5">
    <MudStack Spacing="1">
        <MudTextM3 Typo="TypoM3.Title" Size="Size.Medium" Class="fw-bold">
            Add email
        </MudTextM3>
        <MudStack Row="true" Spacing="1">
            <MudForm Model="Model" @ref="_form" Validation="Validator.ValidateValue" Spacing="0">
                <MudTextFieldExtended
                    Style="width: 400px"
                    Class="my-0"
                    Margin="Margin.Dense"
                    Typo="Typo.body1"
                    @bind-Value="Model.Email"
                    For="() => Model.Email"
                    Variant="Variant.Outlined"
                    Immediate="true"
                    Clearable="true"
                    Error="@_showError"
                    ErrorText="@_error"/>
            </MudForm>
            <MudStack Justify="Justify.FlexStart" AlignItems="AlignItems.Center">
                <MudButton
                    Style="height: 39px"
                    Variant="Variant.Outlined"
                    ButtonType="ButtonType.Button"
                    Size="Size.Medium"
                    OnClick="@(async () => await OnAddAsync())">
                    Add
                </MudButton>
            </MudStack>
        </MudStack>
        <MudTextM3 Typo="TypoM3.Body" Size="Size.Small" Class="opacity-50">
            Enter an email address, that will be used as additional.
            Also you will be able to set this email as recovery or primary.
        </MudTextM3>
    </MudStack>
</MudPaper>

@code {
    [Parameter] public EventCallback OnRefresh { get; set; }

    private AddEmailModel Model { get; set; } = new();
    private MudForm _form = new();

    private string? _error;
    private bool _showError = false;

    private async Task OnAddAsync()
    {
        await _form.Validate();

        if (_form is { IsValid: true, IsTouched: true })
        {
            var request = new CheckEmailRequest
            {
                UserId = UserState.UserId,
                Email = Model.Email!
            };

            var result = await EmailService.CheckEmailAsync(request);

            if (result.Succeeded)
            {
                _showError = false;
                _error = null;
                await AddEmailAsync();
            }
            else
            {
                _showError = true;
                _error = result.GetError().Description;
            }
        }
        else if (!_form.IsValid) _showError = true;
    }

    private async Task AddEmailAsync()
    {
        var request = new AddEmailRequest
        {
            UserId = UserState.UserId,
            Email = Model.Email!,
        };

        var result = await EmailService.AddEmailAsync(request);

        if (result.Succeeded)
        {
            Model = new();
            await OnRefresh.InvokeAsync();
        }
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

}