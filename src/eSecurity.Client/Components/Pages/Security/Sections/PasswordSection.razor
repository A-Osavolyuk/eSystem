@using eSecurity.Core.Common.DTOs
@inject IDialogService DialogService
@inject UserState UserState

<MudStack Spacing="0" Class="px-5">
    <MudStack Row="true" Spacing="3">
        <MudStack>
            <MudIcon Icon="@Icons.Material.Outlined.Password" Class="mt-1"/>
        </MudStack>
        <MudStack Spacing="0">
            <MudStack Spacing="0" Row="true">
                <MudTextM3 Typo="TypoM3.Title" Size="Size.Medium" Class="pt-2 fw-bold">
                    Password
                </MudTextM3>
                @if (Model.HasPassword)
                {
                    <MudChip
                        T="string"
                        Class="mt-2"
                        Color="Color.Success"
                        Variant="Variant.Outlined"
                        Size="Size.Small">
                        Enabled
                    </MudChip>
                }
                else
                {
                    <MudChip
                        T="string"
                        Class="mt-2"
                        Color="Color.Error"
                        Variant="Variant.Outlined"
                        Size="Size.Small">
                        Disabled
                    </MudChip>
                }
            </MudStack>
            <MudTextM3 Class="opacity-50" Typo="TypoM3.Body" Size="Size.Small">
                Primary sign-in method by default.
                You can enable 2FA to add an additional layer of protection.
            </MudTextM3>
        </MudStack>
        <MudSpacer/>
        <MudStack>
            @if (!Model.HasPassword)
            {
                <MudButton
                    Size="Size.Small"
                    Variant="Variant.Outlined"
                    ButtonType="ButtonType.Button"
                    OnClick="@(async () => await OnAddPasswordAsync())">
                    Add password
                </MudButton>
            }
            else
            {
                <MudMenu
                    Dense="true">
                    <ActivatorContent>
                        <MudIcon Icon="@Icons.Material.Filled.MoreHoriz"/>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem OnClick="@(async () => await OnChangePasswordAsync())">
                            <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                Change password
                            </MudTextM3>
                        </MudMenuItem>
                        <MudMenuItem Href="@(OnReset())">
                            <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Color="Color.Error">
                                Reset password
                            </MudTextM3>
                        </MudMenuItem>
                        <MudDivider/>
                        <MudMenuItem Href="@(OnRemove())">
                            <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Color="Color.Error">
                                Remove password
                            </MudTextM3>
                        </MudMenuItem>
                    </ChildContent>
                </MudMenu>
            }
        </MudStack>
    </MudStack>
</MudStack>

@code {
    [Parameter] public PasswordData Model { get; set; } = new();
    [Parameter] public EventCallback OnRefresh { get; set; }

    private async Task OnChangePasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new ChangePasswordModel() { Id = UserState.UserId };

        var parameters = new DialogParameters<ChangePasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>("Change password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnRefresh.InvokeAsync();
            StateHasChanged();
        }
    }

    private async Task OnAddPasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new AddPasswordModel() { UserId = UserState.UserId };

        var parameters = new DialogParameters<AddPasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<AddPasswordDialog>("Add password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnRefresh.InvokeAsync();
            StateHasChanged();
        }
    }

    private string OnReset()
    {
        return QueryBuilder.Create()
            .WithUri(Links.Settings.ResetPassword)
            .WithQueryParam("return_url", Links.Settings.Security)
            .Build();
    }

    private string OnRemove()
    {
        return QueryBuilder.Create()
            .WithUri(Links.Settings.RemovePassword)
            .WithQueryParam("return_url", Links.Settings.Security)
            .Build();
    }
}