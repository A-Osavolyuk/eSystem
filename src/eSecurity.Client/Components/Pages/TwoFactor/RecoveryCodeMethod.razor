@using eSecurity.Client.Security
@using eSecurity.Client.Security.Authorization.Access.Verification
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authentication.TwoFactor
@using eSystem.Core.Security.Authentication.OpenIdConnect.Constants

@inject UserState UserState
@inject ISnackbar Snackbar
@inject ISecurityService SecurityService
@inject IVerificationService VerificationService

<MudStack Spacing="3">
    <MudStack Spacing="4">
        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
            Enter one of the 16 recovery codes saved during 2FA configuration.
        </MudTextM3>
        <MudForm @ref="_form" Model="_model">
            <MudTextFieldExtended
                Mask="@(new PatternMask("**********"))"
                Placeholder="XXXXXXXXXX"
                Variant="Variant.Outlined"
                Immediate="true"
                Clearable="true"
                @bind-Value="_model.Code"
                For="() => _model.Code"/>
        </MudForm>
        <MudStack Spacing="2">
            <MudButton
                Size="Size.Large"
                Color="Color.Primary"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                Disabled="@(_model.Code.Length < 9)"
                OnClick="@(async () => await OnSignInAsync())">
                Verify
            </MudButton>
        </MudStack>
    </MudStack>
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
        <MudDivider Style="max-width: 45%"/>
        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
        <MudDivider Style="max-width: 45%"/>
    </MudStack>
    <MudStack Spacing="2">
        @if (Methods.Any(x => x == TwoFactorMethod.Passkey))
        {
            <MudButton
                Color="Color.Primary"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                Size="Size.Large"
                OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Passkey))">
                Passkey
            </MudButton>
        }
        @if (Methods.Any(x => x == TwoFactorMethod.AuthenticatorApp))
        {
            <MudButton
                Color="Color.Primary"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                Size="Size.Large"
                OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.AuthenticatorApp))">
                Authenticator app
            </MudButton>
        }
        @if (Methods.Any(x => x == TwoFactorMethod.Sms))
        {
            <MudButton
                Color="Color.Primary"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                Size="Size.Large"
                OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Sms))">
                SMS
            </MudButton>
        }
    </MudStack>
</MudStack>

@code {
    [Parameter] public EventCallback<TwoFactorMethod> OnChangeMethod { get; set; }
    [Parameter] public EventCallback<string> OnSignIn { get; set; }
    [Parameter] public List<TwoFactorMethod> Methods { get; set; } = [];

    private CodeModel _model = new();
    private MudForm _form = new();

    private async Task OnSignInAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new VerifyRecoveryCodeRequest
            {
                UserId = UserState.UserId,
                Code = _model.Code,
                Purpose = PurposeType.TwoFactor,
                Action = ActionType.SignIn
            };

            var result = await VerificationService.VerifyRecoveryCodeAsync(request);
            if (result.Succeeded) await OnSignIn.InvokeAsync(AuthenticationMethods.OneTimePassword);
            else
            {
                var error = result.GetError();
                Snackbar.Add(error.Description, Severity.Error);
            }
        }
    }

}