@page "/session/two-factor"

@using eSecurity.Client.Security
@using eSecurity.Client.Security.Identity
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authentication.SignIn
@using eSecurity.Core.Security.Authentication.TwoFactor
@using eSystem.Core.Security.Authentication.OpenIdConnect.Constants
@using eSystem.Core.Utilities.State

@inherits PageBase

@layout AuthenticationLayout

@inject ISecurityService SecurityService

<Title Text="Two-factor authentication"/>

@if (_methods.Any())
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="3" Style="margin-top: 50px">
            <MudPaper Class="pa-10" Elevation="4">
                <MudStack Spacing="3">
                    <MudStack Spacing="3" Justify="Justify.Center" AlignItems="AlignItems.Center">
                        <MudIcon Style="font-size: 5rem" Icon="@Icons.Material.Outlined.LockPerson"/>
                        @if (_preferredMethod != TwoFactorMethod.RecoveryCode)
                        {
                            <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                                Two-factor authentication
                            </MudTextM3>
                        }
                        else
                        {
                            <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                                Two-factor recovery
                            </MudTextM3>
                        }
                    </MudStack>
                    @switch (_preferredMethod)
                    {
                        case TwoFactorMethod.AuthenticatorApp:
                        {
                            <AuthenticatorMethod
                                Methods="_methods"
                                OnSignIn="@(async method => await OnSignInAsync(method))"
                                OnChangeMethod="@((TwoFactorMethod method) => _preferredMethod = method)"/>
                            break;
                        }
                        case TwoFactorMethod.Passkey:
                        {
                            <PasskeyMethod
                                Methods="_methods"
                                OnSignIn="@(async method => await OnSignInAsync(method))"
                                OnChangeMethod="@((TwoFactorMethod method) => _preferredMethod = method)"/>
                            break;
                        }
                        case TwoFactorMethod.RecoveryCode:
                        {
                            <RecoveryCodeMethod
                                Methods="_methods"
                                OnSignIn="@(async method => await OnSignInAsync(method))"
                                OnChangeMethod="@((TwoFactorMethod method) => _preferredMethod = method)"/>
                            break;
                        }
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {

    [SupplyParameterFromQuery(Name = "state")]
    public string? State { get; set; }

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; } = string.Empty;

    private List<TwoFactorMethod> _methods = [];
    private TwoFactorMethod _preferredMethod;
    private string? _state;
    private Guid _transactionId;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(State))
        {
            var stateData = StateParser.Parse(State);
            if (stateData.TryGetValue("transactionId", out var userId))
            {
                _transactionId = Guid.Parse(userId);
                
                var result = await SecurityService.GetAuthenticationSessionAsync(_transactionId);
                if (result.Succeeded && result.TryGetValue<AuthenticationSessionDto>(out var session) && 
                    session?.AllowedMfaMethods != null)
                {
                    if (session.AllowedMfaMethods.Contains(AuthenticationMethods.SoftwareKey))
                    {
                        _preferredMethod = TwoFactorMethod.Passkey;
                        _methods = [
                            TwoFactorMethod.Passkey, 
                            TwoFactorMethod.AuthenticatorApp, 
                            TwoFactorMethod.RecoveryCode
                        ];
                    }
                    else
                    {
                        _preferredMethod = TwoFactorMethod.AuthenticatorApp;
                        _methods = [
                            TwoFactorMethod.AuthenticatorApp, 
                            TwoFactorMethod.RecoveryCode
                        ];
                    }
                }
                else
                {
                    var error = result.GetError();
                    Snackbar.Add(error.Description, Severity.Error);
                }
            }

            if (stateData.TryGetValue("state", out var state))
                _state = state;
        }
    }

    private async Task OnSignInAsync(string method)
    {
        var request = new SignInRequest
        {
            Payload = new TwoFactorSignInPayload
            {
                TransactionId = _transactionId,
                AuthenticationMethod = method
            }
        };

        var result = await SecurityService.SignInAsync(request);
        if (result.Succeeded)
        {
            if (!string.IsNullOrEmpty(_state))
            {
                var stateData = StateParser.Parse(_state);
                if (stateData.TryGetValue("return_url", out var returnUrl))
                {
                    NavigationManager.NavigateTo(returnUrl);
                    return;
                }
            }

            NavigationManager.NavigateTo(AuthenticationManager.GetAuthorizationUri(ReturnUrl));
        }
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }

}
