@using eSecurity.Client.Common.JS.WebAuthN
@using eSecurity.Client.Security.Authorization.Access.Verification
@using eSecurity.Client.Security.Credentials.PublicKey
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authentication.TwoFactor
@using eSecurity.Core.Security.Credentials.PublicKey

@inject UserState UserState
@inject WebAuthNManager WebAuthNManager
@inject ISnackbar Snackbar
@inject IPasskeyService PasskeyService
@inject IVerificationService VerificationService

<MudPaper Outlined="true" Class="pa-5">
    <MudStack Spacing="4" Class="w-100">
        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
            Authenticate using your passkey.
        </MudTextM3>
        <MudStack Spacing="2">
            <MudButton
                FullWidth="true"
                Size="Size.Medium"
                Color="Color.Primary"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                OnClick="@(async () => await OnSignInAsync())">
                Use passkey
            </MudButton>
        </MudStack>
    </MudStack>
</MudPaper>
<MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
    <MudDivider Style="max-width: 45%"/>
    <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
    <MudDivider Style="max-width: 45%"/>
</MudStack>
<MudPaper Outlined="true" Class="pa-5">
    <MudStack Spacing="2">
        <MudButton
            FullWidth="true"
            Color="Color.Info"
            Variant="Variant.Filled"
            ButtonType="ButtonType.Button"
            Size="Size.Medium"
            OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.AuthenticatorApp))">
            Authenticator app
        </MudButton>
        @if (Methods.Any(x => x.Method == TwoFactorMethod.Sms))
        {
            <MudButton
                Color="Color.Info"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                Size="Size.Medium"
                OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.Sms))">
                SMS
            </MudButton>
        }
        <MudButton
            FullWidth="true"
            Color="Color.Error"
            Variant="Variant.Filled"
            ButtonType="ButtonType.Button"
            Size="Size.Medium"
            OnClick="@(async () => await OnChangeMethod.InvokeAsync(TwoFactorMethod.RecoveryCode))">
            Recovery codes
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    [Parameter] 
    public EventCallback<TwoFactorMethod> OnChangeMethod { get; set; }
    
    [Parameter] 
    public EventCallback OnSignIn { get; set; }

    [Parameter] 
    public List<UserTwoFactorMethod> Methods { get; set; } = [];

    private async Task OnSignInAsync()
    {
        var request = new GenerateRequestOptionsRequest() { UserId = UserState.UserId };
        var result = await PasskeyService.GenerateRequestOptionsAsync(request);

        if (result.Succeeded)
        {
            var options = result.Get()!;
            var authenticateResult = await WebAuthNManager.AuthenticateAsync(options);
            if (authenticateResult.Success)
            {
                var credential = authenticateResult.Get<PublicKeyCredential>();
                await SignInAsync(credential);
            }
        }
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

    private async Task SignInAsync(PublicKeyCredential credential)
    {
        var request = new VerifyPasskeyRequest()
        {
            UserId = UserState.UserId,
            Credential = credential,
            Action = ActionType.SignIn,
            Purpose = PurposeType.TwoFactor
        };
        
        var result = await VerificationService.VerifyPasskeyAsync(request);
        if (result.Succeeded) await OnSignIn.InvokeAsync();
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }
}