@page "/session/two-factor"

@using eSecurity.Client.Security
@using eSecurity.Client.Security.Identity
@using eSecurity.Core.Common.DTOs
@using eSecurity.Core.Security.Authentication.SignIn
@using eSecurity.Core.Security.Authentication.SignIn.Session
@using eSecurity.Core.Security.Authentication.TwoFactor

@inherits PageBase

@inject IUserService UserService
@inject ISecurityService SecurityService

<Title Text="Two-factor authentication"/>

@if (_methods.Any())
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="3" Style="margin-top: 50px">
            <MudStack Spacing="1">
                <MudPaper Class="pa-3" Outlined="true">
                    <MudStack Spacing="3" Justify="Justify.Center" AlignItems="AlignItems.Center">
                        <MudIcon Size="Size.Large" Icon="@Icons.Material.Outlined.LockPerson"/>
                        @if (_preferredMethod != TwoFactorMethod.RecoveryCode)
                        {
                            <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                                Two-factor authentication
                            </MudTextM3>
                        }
                        else
                        {
                            <MudTextM3 Typo="TypoM3.Headline" Size="Size.Small">
                                Two-factor recovery
                            </MudTextM3>
                        }
                    </MudStack>
                </MudPaper>
                @switch (_preferredMethod)
                {
                    case TwoFactorMethod.AuthenticatorApp:
                    {
                        <AuthenticatorMethod
                            Methods="_methods"
                            OnSignIn="@(async () => await OnSignInAsync())"
                            OnChangeMethod="@((TwoFactorMethod method) => _preferredMethod = method )"/>
                        break;
                    }
                    case TwoFactorMethod.Passkey:
                    {
                        <PasskeyMethod
                            Methods="_methods"
                            OnSignIn="@(async () => await OnSignInAsync())"
                            OnChangeMethod="@((TwoFactorMethod method) => _preferredMethod = method )"/>
                        break;
                    }
                    case TwoFactorMethod.RecoveryCode:
                    {
                        <RecoveryCodeMethod
                            Methods="_methods"
                            OnSignIn="@(async () => await OnSignInAsync())"
                            OnChangeMethod="@((TwoFactorMethod method) => _preferredMethod = method )"/>
                        break;
                    }
                }
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {

    [SupplyParameterFromQuery(Name = "sid")]
    public Guid SessionId { get; set; }

    private List<UserTwoFactorMethod> _methods = [];
    private TwoFactorMethod _preferredMethod;

    protected override async Task OnInitializedAsync()
    {
        var result = await SecurityService.LoadSignInSessionAsync(SessionId);
        if (result.Succeeded)
        {
            var response = result.Get();
            if (response.UserId.HasValue)
            {
                UserState.UserId = response.UserId.Value;
                await LoadMethods();
            }
            else
            {
                Snackbar.Add("Invalid session");
            }
        }
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }
    
    private async Task LoadMethods()
    {
        var result = await UserService.GetUserTwoFactorMethodsAsync(UserState.UserId);
        if (result.Succeeded)
        {
            _methods = result.Get()!;
            _preferredMethod = _methods.Single(x => x.Preferred).Method;
        }
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }

    private async Task OnSignInAsync()
    {
        var request = new SignInRequest()
        {
            Payload = new TwoFactorSignInPayload()
            {
                Sid = SessionId
            }
        };
        
        var result = await SecurityService.SignInAsync(request);
        if (result.Succeeded) AuthenticationManager.Authorize();
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }
}
