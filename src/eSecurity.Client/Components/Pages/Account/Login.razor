@page "/login"

@layout AuthenticationLayout
@using eSecurity.Client.Security
@using eSecurity.Core.Common.Responses
@using eSystem.Core.Utilities.State
@using eSecurity.Client.Security.Authentication
@using eSecurity.Client.Components.Pages.OAuth

@inject ISecurityService SecurityService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AuthenticationManager AuthenticationManager

<Title Text="Log in to eSystem"></Title>

<MudGrid Justify="Justify.Center">
    <MudItem xs="3" Style="margin-top: 50px">
        <MudPaper Elevation="4" Class="pa-10">
            <MudStack Spacing="3">
                <MudStack Spacing="3" AlignItems="AlignItems.Center">
                    <MudIcon Style="font-size: 5rem" Icon="@Icons.Material.Filled.Lock"/>
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Headline" Size="Size.Small">
                        Welcome
                    </MudTextM3>
                </MudStack>
                <MudStack Spacing="3">
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Body" Size="Size.Medium">
                        Log in to eSystem Account to continue to eAccount
                    </MudTextM3>
                    <MudForm Model="_model" @ref="_form">
                        <MudTextFieldExtended
                            T="string"
                            Immediate="true"
                            @bind-Value="_model.Login"
                            For="() => _model.Login"
                            Typo="Typo.body1"
                            Label="Login"
                            Variant="Variant.Outlined"
                            Error="_showError"
                            ErrorText="@_error"/>
                    </MudForm>
                    <MudStack Spacing="3">
                        <MudButton
                            Size="Size.Large"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            OnClick="@(async () => await OnContinueAsync())"
                            Disabled="@(string.IsNullOrEmpty(_model.Login))">
                            Continue
                        </MudButton>
                        <MudTextM3 Size="Size.Medium" Typo="TypoM3.Body">
                            Don't have an account?
                            <MudLink Typo="Typo.body2" Href="@OnSignUp()">Sign up</MudLink>
                        </MudTextM3>
                    </MudStack>
                </MudStack>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudDivider Style="max-width: 45%"/>
                    <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
                    <MudDivider Style="max-width: 45%"/>
                </MudStack>
                <MudStack Spacing="1">
                    <PasskeySignIn/>
                    <Providers/>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {

    [SupplyParameterFromQuery(Name = "state")]
    public string? State { get; set; } = string.Empty;
    
    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; } = string.Empty;

    private CheckLoginModel _model = new();
    private MudForm _form = new();

    private string? _error;
    private bool _showError;

    private async Task OnContinueAsync()
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            var request = new CheckAccountRequest { Login = _model.Login };
            var result = await SecurityService.CheckAccountAsync(request);
            if (result.Succeeded && result.TryGetValue<CheckAccountResponse>(out var response) && response is not null)
            {
                if (!response.Exists)
                {
                    _error = "Account with such login was not found.";
                    _showError = true;

                    return;
                }

                _error = null;
                _showError = false;

                var state = StateBuilder.Create()
                    .WithData("login", _model.Login)
                    .WithData("state", string.IsNullOrEmpty(State) 
                        ? AuthenticationManager.GetAuthorizationState(ReturnUrl) 
                        : State)
                    .Build();
                
                NavigationManager.NavigateTo(QueryBuilder.Create()
                    .WithUri(Links.Common.PasswordSignIn)
                    .WithQueryParam("state", state)
                    .Build());
            }
            else
            {
                var error = result.GetError();
                Snackbar.Add(error.Description, Severity.Error);
            }
        }
    }

    private string OnSignUp()
    {
        var state = string.IsNullOrEmpty(State)
            ? AuthenticationManager.GetAuthorizationState(ReturnUrl)
            : State;
        
        var builder = QueryBuilder.Create()
            .WithUri(Links.Common.SignUp)
            .WithQueryParam("state", state);

        return builder.Build();
    }
}