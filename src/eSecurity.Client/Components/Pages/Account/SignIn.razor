@page "/sign-in"

@using eSecurity.Client.Components.Pages.OAuth
@using eSecurity.Client.Security
@using eSecurity.Core.Security.Authentication.SignIn
@using eSecurity.Core.Security.Authentication.SignIn.Session

@inherits PageBase

@inject LoginValidator Validator
@inject ISecurityService SecurityService

<Title Text="Sign in for eSecurity"/>

<MudGrid Justify="Justify.Center">
    <MudItem xs="4" Style="margin-top: 50px">
        <MudStack Spacing="2" Justify="Justify.Center">
            <MudStack Spacing="1">
                <MudPaper Outlined Class="pa-3">
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Headline" Size="Size.Small">
                        Sign in for eSecurity
                    </MudTextM3>
                </MudPaper>
                <MudPaper Outlined Class="pa-3">
                    <MudStack Spacing="2">
                        <MudForm
                            @ref="_form"
                            Model="_model"
                            Validation="Validator.ValidateValue">
                            <MudTextFieldExtended
                                Margin="Margin.Dense"
                                @bind-Value="_model.Login"
                                For="(() => _model.Login)"
                                Label="Login"
                                Immediate
                                Variant="Variant.Outlined"/>
                            <MudPasswordField
                                Margin="Margin.Dense"
                                PasswordMode="true"
                                @bind-Value="_model.Password"
                                For="(() => _model.Password)"
                                Label="Password"
                                Immediate
                                Variant="Variant.Outlined"
                                IconSize="Size.Small"/>
                        </MudForm>
                        <MudLoadingButton
                            LoadingAdornment="Adornment.End"
                            ButtonType="ButtonType.Button"
                            OnClick="@(async () => await OnSignInAsync())"
                            StartIcon="@Icons.Material.Filled.Login"
                            Disabled="@(string.IsNullOrEmpty(_model.Password) || string.IsNullOrEmpty(_model.Login))"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            FullWidth="true"
                            Size="Size.Medium">
                            Sign in
                        </MudLoadingButton>
                    </MudStack>
                </MudPaper>
            </MudStack>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
                <MudDivider Style="max-width: 45%"/>
                <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
                <MudDivider Style="max-width: 45%"/>
            </MudStack>
            <MudStack Spacing="1">
                <MudPaper Class="pa-3" Outlined="true">
                    <MudStack Spacing="1">
                        <MudLoadingButton
                            LoadingAdornment="Adornment.End"
                            ButtonType="ButtonType.Button"
                            StartIcon="@Icons.Material.Filled.Key"
                            Variant="Variant.Filled"
                            Color="Color.Info"
                            Href="@Links.Common.WebAuthN"
                            Size="Size.Medium"
                            FullWidth="true">
                            Continue with Passkey
                        </MudLoadingButton>
                        <Providers/>
                    </MudStack>
                </MudPaper>
                <MudPaper Outlined Class="pa-3">
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Body" Size="Size.Medium">
                        Do not have an account yet?
                        <MudLink Typo="Typo.body2" Href="@Links.Common.SignUp">
                            Sign up
                        </MudLink>
                    </MudTextM3>
                </MudPaper>
                <MudPaper Outlined Class="pa-3">
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Body" Size="Size.Medium">
                        Forgot your password?
                        <MudLink Typo="Typo.body2" Href="@OnForgotPassword()">
                            Reset password
                        </MudLink>
                    </MudTextM3>
                </MudPaper>
                <MudPaper Outlined Class="pa-3">
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Body" Size="Size.Medium">
                        Lost access to your account?
                        <MudLink Typo="Typo.body2" Href="@OnRecoverAccount()">
                            Recover account
                        </MudLink>
                    </MudTextM3>
                </MudPaper>
            </MudStack>
        </MudStack>
    </MudItem>
</MudGrid>

@code {

    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; } = string.Empty;

    private readonly LoginModel _model = new();
    private MudForm _form = new();

    private async Task OnSignInAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new SignInRequest()
            {
                Payload = new PasswordSignInPayload()
                {
                    Password = _model.Password,
                    Login = _model.Login
                }
            };
            var result = await SecurityService.SignInAsync(request);

            if (result.Succeeded)
            {
                var response = result.Get()!;
                var sid = response.SessionId;

                var sessionResult = await SecurityService.LoadSignInSessionAsync(sid);
                if (sessionResult.Succeeded)
                {
                    var session = sessionResult.Get();

                    if (!session.UserId.HasValue)
                    {
                        Snackbar.Add("Invalid session", Severity.Error);
                        return;
                    }
                    
                    switch (session.NextStep)
                    {
                        case SignInStep.Complete:
                        {
                            UserState.UserId = session.UserId.Value;
                            AuthenticationManager.Authorize();
                            break;
                        }
                        case SignInStep.DeviceTrust:
                        {
                            var builder = QueryBuilder.Create()
                                .WithUri(Links.Session.DeviceTrust)
                                .WithQueryParam("sid", session.Id.ToString());

                            if (!string.IsNullOrEmpty(ReturnUrl))
                                builder.WithQueryParam("return_url", ReturnUrl);

                            const string message = "This device is untrusted. You need to trust it first.";
                            Snackbar.Add(message, Severity.Info);
                    
                            NavigationManager.NavigateTo(builder.Build());
                            break;
                        }
                        case SignInStep.TwoFactor:
                        {
                            var builder = QueryBuilder.Create()
                                .WithUri(Links.Session.TwoFactorSignIn)
                                .WithQueryParam("sid", session.Id.ToString());

                            if (!string.IsNullOrEmpty(ReturnUrl))
                                builder.WithQueryParam("return_url", ReturnUrl);

                            NavigationManager.NavigateTo(builder.Build());
                            break;
                        }
                        default:
                        {
                            Snackbar.Add("Invalid session", Severity.Error);
                            break;
                        }
                    }
                }
                else
                {
                    var error = sessionResult.GetError();
                    Snackbar.Add(error.Description, Severity.Error);
                }
            }
            else
            {
                var error = result.GetError();
                
                if (error.Code == Errors.Common.UnverifiedEmail)
                {
                    var userId = error.Details["userId"].ToString()!;
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Common.CompleteRegistration)
                        .WithQueryParam("id", userId);

                    Snackbar.Add(result.GetError().Description, Severity.Info);
                    NavigationManager.NavigateTo(builder.Build());
                    return;
                }

                if (error.Code == Errors.Common.FailedLoginAttempt)
                {
                    var maxFailedLoginAttempts = Convert.ToInt32(error.Details["maxFailedLoginAttempts"].ToString());
                    var failedLoginAttempts = Convert.ToInt32(error.Details["failedLoginAttempts"].ToString());
                    var attemptsLeft = maxFailedLoginAttempts- failedLoginAttempts;
                    var message = $"Incorrect password. You have {attemptsLeft} attempts left.";
                    Snackbar.Add(message, Severity.Error);
                    return;
                }

                if (error.Code is Errors.Common.TooManyFailedLoginAttempts or Errors.Common.AccountLockedOut)
                {
                    var userId = error.Details["userId"].ToString()!;
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Common.AccountLocked)
                        .WithQueryParam("id", userId);

                    NavigationManager.NavigateTo(builder.Build());
                }
                else Snackbar.Add(result.GetError().Description, Severity.Error);
            }
        }
    }

    private string OnForgotPassword()
    {
        return QueryBuilder.Create()
            .WithUri(Links.Common.ForgotPassword)
            .WithQueryParam("return_url", Links.Common.SignIn)
            .Build();
    }

    private string OnRecoverAccount()
    {
        return QueryBuilder.Create()
            .WithUri(Links.Common.RecoverAccount)
            .WithQueryParam("return_url", Links.Common.SignIn)
            .Build();
    }

}
