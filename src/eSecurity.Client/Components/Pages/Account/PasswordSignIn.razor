@page "/login/password"

@using eSecurity.Core.Security.Authentication.SignIn
@using eSecurity.Client.Security
@using eSecurity.Core.Common.Responses
@using eSecurity.Client.Security.Authentication
@using eSystem.Core.Security.Authentication.OpenIdConnect.Constants
@using eSystem.Core.Utilities.State

@layout AuthenticationLayout

@inject NavigationManager NavigationManager
@inject AuthenticationManager AuthenticationManager
@inject ISnackbar Snackbar
@inject ISecurityService SecurityService

<Title Text="Log in to eSystem"></Title>

<MudGrid Justify="Justify.Center">
    <MudItem xs="3" Style="margin-top: 50px">
        <MudPaper Elevation="4" Class="pa-10">
            <MudStack Spacing="3">
                <MudStack Spacing="3" AlignItems="AlignItems.Center">
                    <MudIcon Style="font-size: 5rem" Icon="@Icons.Material.Filled.Lock"/>
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Headline" Size="Size.Small">
                        Enter your password
                    </MudTextM3>
                </MudStack>
                <MudStack Spacing="3">
                    <MudTextM3 Align="Align.Center" Typo="TypoM3.Body" Size="Size.Medium">
                        Enter your password for eSystem Account to continue to eAccount
                    </MudTextM3>
                    <MudStack Spacing="1">
                        <MudForm Model="_model" @ref="_form">
                            <MudTextFieldExtended
                                T="string"
                                @bind-Value="_model.Login"
                                For="() => _model.Login"
                                Typo="Typo.body1"
                                Label="Login"
                                Variant="Variant.Outlined"
                                Disabled="true"/>
                            <MudPasswordField
                                T="string"
                                @bind-Value="_model.Password"
                                For="() => _model.Password"
                                Typo="Typo.body1"
                                Label="Password"
                                Variant="Variant.Outlined"
                                PasswordMode="true"
                                Error="_showError"
                                ErrorText="@_error"/>
                        </MudForm>
                    </MudStack>
                    <MudLink Typo="Typo.body2" Href="@Links.Common.ForgotPassword">Forgot password?</MudLink>
                    <MudStack Spacing="3">
                        <MudButton
                            Size="Size.Large"
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            OnClick="@(async () => await OnContinueAsync())"
                            Disabled="@(string.IsNullOrEmpty(_model.Password))">
                            Continue
                        </MudButton>
                        <MudTextM3 Size="Size.Medium" Typo="TypoM3.Body">
                            Don't have an account?
                            <MudLink Typo="Typo.body2" Href="@Links.Common.SignUp">Sign up</MudLink>
                        </MudTextM3>
                    </MudStack>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {

    [SupplyParameterFromQuery(Name = "state")]
    public string? State { get; set; }
    
    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; } = string.Empty;

    private LoginModel _model = new();
    private MudForm _form = new();

    private string? _error;
    private bool _showError;
    private string? _authorizationState;

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(State))
        {
            NavigationManager.NavigateTo(QueryBuilder.Create()
                .WithUri(Links.Common.Login)
                .WithQueryParam("state", AuthenticationManager.GetAuthorizationState(ReturnUrl))
                .Build());
        }
        else
        {
            var state = StateParser.Parse(State);
            if (!state.TryGetValue("login", out var login))
            {
                NavigationManager.NavigateTo(QueryBuilder.Create()
                    .WithUri(Links.Common.Login)
                    .WithQueryParam("state", AuthenticationManager.GetAuthorizationState(ReturnUrl))
                    .Build());
                
                return;
            }

            _model.Login = login;

            if (state.TryGetValue("state", out var authorizationState))
            {
                _authorizationState = authorizationState;
            }
        }
    }

    private async Task OnContinueAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new SignInRequest
            {
                Payload = new PasswordSignInPayload
                {
                    Password = _model.Password,
                    Login = _model.Login
                }
            };

            var result = await SecurityService.SignInAsync(request);
            if (result.Succeeded && result.TryGetValue<SignInResponse>(out var response) && response is not null)
            {
                if (!response.SessionId.HasValue)
                {
                    var state = StateBuilder.Create()
                        .WithData("transactionId", response.TransactionId.ToString())
                        .WithData("state", string.IsNullOrEmpty(_authorizationState)
                            ? AuthenticationManager.GetAuthorizationState(ReturnUrl)
                            : _authorizationState)
                        .Build();
                    
                    NavigationManager.NavigateTo(QueryBuilder.Create()
                        .WithUri(Links.Session.TwoFactor)
                        .WithQueryParam("state", state)
                        .WithQueryParam("amr", AuthenticationMethods.Password)
                        .Build());
                }
                else
                {
                    await AuthenticationManager.SignInAsync(response.SessionId!.Value);
                    if (!string.IsNullOrEmpty(_authorizationState))
                    {
                        var authorizationStateData = StateParser.Parse(_authorizationState);
                        if (authorizationStateData.TryGetValue("return_url", out var returnUrl))
                        {
                            NavigationManager.NavigateTo(returnUrl);
                            return;
                        }
                    }
                    
                    NavigationManager.NavigateTo(AuthenticationManager.GetAuthorizationUri(ReturnUrl));
                }
            }
            else
            {
                var error = result.GetError();
                if (error.Code == ErrorTypes.Common.UnverifiedEmail)
                {
                    var userId = error.Details["userId"].ToString()!;
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Common.VerifySignUp)
                        .WithQueryParam("id", userId);

                    Snackbar.Add(result.GetError().Description, Severity.Info);
                    NavigationManager.NavigateTo(builder.Build());
                    return;
                }

                if (error.Code == ErrorTypes.Common.FailedLoginAttempt)
                {
                    var maxFailedLoginAttempts = Convert.ToInt32(error.Details["maxFailedLoginAttempts"].ToString());
                    var failedLoginAttempts = Convert.ToInt32(error.Details["failedLoginAttempts"].ToString());
                    var attemptsLeft = maxFailedLoginAttempts - failedLoginAttempts;

                    _error = $"Incorrect password. You have {attemptsLeft} attempts left.";
                    _showError = true;
                    return;
                }

                if (error.Code is ErrorTypes.Common.TooManyFailedLoginAttempts or ErrorTypes.Common.AccountLockedOut)
                {
                    var userId = error.Details["userId"].ToString()!;
                    var builder = QueryBuilder.Create()
                        .WithUri(Links.Common.AccountLocked)
                        .WithQueryParam("id", userId);

                    NavigationManager.NavigateTo(builder.Build());
                }
                else Snackbar.Add(result.GetError().Description, Severity.Error);
            }
        }
    }

}