@using eSecurity.Client.Security.Authentication.Oidc.Session
@using eSecurity.Client.Security.Authentication.Oidc.Token
@using eSystem.Core.Security.Authentication.Oidc.Client

@inject UserState UserState
@inject ITokenProvider TokenProvider
@inject ISessionAccessor SessionAccessor
@inject IOptions<ClientOptions> ClientOptions

<MudAvatar @onclick="DrawerToggle">
    <MudImage
        Src="/images/avatar.jpg"
        Alt="Avatar"
        FallbackSrc="/images/avatar.jpg"/>
</MudAvatar>
<MudDrawer Class="py-3"
           @bind-Open="_isDrawerOpen"
           ClipMode="DrawerClipMode.Never"
           Overlay="true"
           Anchor="Anchor.End"
           Variant="DrawerVariant.Temporary"
           Width="300px"
           Elevation="2">
    <MudDrawerHeader Class="w-100">
        <MudStack Class="w-100">
            <MudStack Row="true" Justify="Justify.Center">
                <MudAvatar Size="Size.Large">
                    <MudImage
                        Src="/images/avatar.jpg"
                        Alt="Avatar"
                        FallbackSrc="/images/avatar.jpg"/>

                </MudAvatar>
            </MudStack>
            @if (!string.IsNullOrEmpty(UserState.Credentials?.Username))
            {
                <MudText Inline="true" Align="Align.Center"> @UserState.Credentials!.Username </MudText>
            }
            <MudDivider/>
        </MudStack>
    </MudDrawerHeader>
    <MudNavMenu Color="Color.Primary" Class="px-3">
        <MudNavLink
            Href="@Links.Common.Profile"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.AccountBox">
            Profile
        </MudNavLink>
        <MudNavLink
            Href="@Links.Account.SettingsPage"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Settings">
            Settings
        </MudNavLink>
        <MudNavLink
            Href="@Links.Settings.Security"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Security">
            Password and authentication
        </MudNavLink>
        <MudNavLink
            Href="@Links.Settings.Devices"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Devices">
            Devices
        </MudNavLink>
        <MudNavLink
            Href="@Links.Settings.Emails"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Email">
            Emails
        </MudNavLink>
        <MudNavLink
            Href="@Links.Settings.PhoneNumbers"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Smartphone">
            Phone numbers
        </MudNavLink>
        <MudDivider Class="my-2"/>
        <MudNavLink
            OnClick="@(async () => await OnLogoutAsync())"
            Match="NavLinkMatch.All"
            Icon="@Icons.Material.Filled.Logout">
            Logout
        </MudNavLink>
    </MudNavMenu>
</MudDrawer>

@code {
    private bool _isDrawerOpen = false;

    private void DrawerToggle() => _isDrawerOpen = !_isDrawerOpen;

    private async Task OnLogoutAsync()
    {
        var session = SessionAccessor.Get();
        if (session is not null)
        {
            var idToken = await TokenProvider.GetAsync($"{session.Id}:{TokenTypes.IdToken}");
            if (!string.IsNullOrEmpty(idToken))
            {
                QueryBuilder.Create()
                    .WithUri(Links.Connect.Logout)
                    .WithQueryParam("id_token_hint", idToken)
                    .WithQueryParam("post_logout_redirect_uri", ClientOptions.Value.PostLogoutRedirectUri)
                    .WithQueryParam("state", Guid.CreateVersion7().ToString())
                    .WithQueryParam("client_id", ClientOptions.Value.ClientId)
                    .WithQueryParam("local", "true")
                    .Build();
            }
        }
    }
}