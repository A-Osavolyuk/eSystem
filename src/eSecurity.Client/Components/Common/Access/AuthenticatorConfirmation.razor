@using eSecurity.Client.Security.Authorization.Access.Verification
@using eSecurity.Core.Common.DTOs

@inject UserState UserState
@inject ISnackbar Snackbar
@inject IVerificationService VerificationService

<MudStack Spacing="3">
    <MudStack Spacing="3">
        <MudForm @ref="_form" Model="CodeModel">
            <MudTextFieldExtended
                Variant="Variant.Outlined"
                Immediate="true"
                Mask="@_mask"
                Placeholder="XXXXXX"
                @bind-Value="CodeModel.Code"/>
        </MudForm>
        <MudLoadingButton
            ButtonType="ButtonType.Button"
            Variant="Variant.Filled"
            Color="Color.Primary"
            Size="Size.Large"
            FullWidth="true"
            Disabled="@(CodeModel.Code.Length <= 5)"
            OnClick="@(async () => await OnVerifyAsync())">
            Verify code
        </MudLoadingButton>
    </MudStack>
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
        <MudDivider Style="max-width: 45%"/>
        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
        <MudDivider Style="max-width: 45%"/>
    </MudStack>
    <MudStack Spacing="3">
        @if (Model.PasskeyEnabled)
        {
            <MudButton
                Color="Color.Primary"
                Size="Size.Large"
                Variant="Variant.Filled"
                OnClick="@(async () => await OnMethodChanged.InvokeAsync(VerificationMethod.Passkey))">
                Continue with passkey
            </MudButton>
        }
        <MudButton
            Color="Color.Primary"
            Size="Size.Large"
            Variant="Variant.Filled"
            OnClick="@(async () => await OnMethodChanged.InvokeAsync(VerificationMethod.Email))">
            Continue with email
        </MudButton>
    </MudStack>
</MudStack>

@code {
    [Parameter] public EventCallback OnAccessConfirmed { get; set; }

    [Parameter] public EventCallback<VerificationMethod> OnMethodChanged { get; set; }

    [Parameter] public ConfirmationContext Context { get; set; } = null!;

    [Parameter] public UserVerificationData Model { get; set; } = new();

    private CodeModel CodeModel { get; set; } = new();
    private readonly PatternMask _mask = new("000000");
    private MudForm _form = new();

    private async Task OnVerifyAsync()
    {
        var request = new VerifyAuthenticatorCodeRequest
        {
            UserId = UserState.UserId,
            Code = CodeModel.Code,
            Action = Context.Action,
            Purpose = Context.Purpose
        };

        var result = await VerificationService.VerifyAuthenticatorCodeAsync(request);

        if (result.Succeeded) await OnAccessConfirmed.InvokeAsync();
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

}