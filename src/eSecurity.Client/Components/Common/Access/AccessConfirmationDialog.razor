@using eSecurity.Client.Security.Identity
@using eSecurity.Core.Common.DTOs
@inject UserState UserState

@inject ISnackbar Snackbar
@inject IUserService UserService

@if (_model is not null)
{
    <MudDialog Style="width: 600px">
        <DialogContent>
            <MudStack Justify="Justify.Center" Class="pa-10">
                <MudStack AlignItems="AlignItems.Center">
                    <MudIcon Style="font-size: 5rem" Icon="@Icons.Material.Filled.Lock"/>
                </MudStack>
                <MudTextM3 Typo="TypoM3.Headline" Size="Size.Medium" Align="Align.Center">
                    Confirm access
                </MudTextM3>
                @switch (_model.PreferredMethod)
                {
                    case VerificationMethod.Email:
                    {
                        <EmailConfirmation
                            Model="_model"
                            Context="Context"
                            OnMethodChanged="ChangeMethodAsync"
                            OnAccessConfirmed="ConfirmAccessAsync"/>
                        break;
                    }
                    case VerificationMethod.Passkey:
                    {
                        <PasskeyConfirmation
                            Model="_model"
                            Context="Context"
                            OnMethodChanged="ChangeMethodAsync"
                            OnAccessConfirmed="ConfirmAccessAsync"/>
                        break;
                    }
                    case VerificationMethod.AuthenticatorApp:
                    {
                        <AuthenticatorConfirmation
                            Model="_model"
                            Context="Context"
                            OnMethodChanged="ChangeMethodAsync"
                            OnAccessConfirmed="ConfirmAccessAsync"/>
                        break;
                    }
                }
            </MudStack>
        </DialogContent>
    </MudDialog>
}


@code {
    [CascadingParameter] public IMudDialogInstance Dialog { get; set; } = null!;
    [Parameter] public ConfirmationContext Context { get; set; } = null!;

    private UserVerificationData? _model;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task ChangeMethodAsync(VerificationMethod method)
    {
        await InvokeAsync(StateHasChanged);
        _model?.PreferredMethod = method;
    }

    private async Task ConfirmAccessAsync()
    {
        Dialog.Close(DialogResult.Ok(true));
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadAsync()
    {
        var result = await UserService.GetUserVerificationMethodsAsync(UserState.UserId);

        if (result.Succeeded && result.TryGetValue<UserVerificationData>(out var value))
        {
            _model = value;
        }
        else
        {
            var error = result.GetError();
            Snackbar.Add(error.Description, Severity.Error);
        }
    }

}