@using eSecurity.Client.Security.Authorization.Access.Verification
@using eSecurity.Core.Common.DTOs

@inject UserState UserState
@inject ISnackbar Snackbar
@inject IVerificationService VerificationService

<MudStack Spacing="3">
    <MudStack>
        @if (_sendStage)
        {
            <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
                When you are ready, trigger a mailer to verify your identity.
            </MudTextM3>
            <MudButton
                Color="Color.Primary"
                Variant="Variant.Filled"
                ButtonType="ButtonType.Button"
                Size="Size.Large"
                OnClick="@(async () => await OnSendAsync())">
                Verify via email
            </MudButton>
        }
        else
        {
            <MudStack Spacing="1">
                <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
                    Enter the code sent to:
                    <strong>@UserState.Credentials?.Email!</strong>
                </MudTextM3>
                <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Align="Align.Center">
                    If it doesn’t appear within a few minutes, check your spam folder.
                </MudTextM3>
            </MudStack>
            <MudForm @ref="_form" Model="CodeModel">
                <MudTextFieldExtended
                    Variant="Variant.Outlined"
                    Immediate="true"
                    Mask="@_mask"
                    Placeholder="XXXXXX"
                    @bind-Value="CodeModel.Code"/>
            </MudForm>
            <MudLoadingButton
                ButtonType="ButtonType.Button"
                Variant="Variant.Filled"
                Color="Color.Primary"
                Size="Size.Large"
                FullWidth="true"
                Disabled="@(CodeModel.Code.Length <= 5)"
                OnClick="@(async () => await OnVerifyAsync())">
                Verify code
            </MudLoadingButton>
        }
    </MudStack>
    @if (Model.PasskeyEnabled || Model.AuthenticatorEnabled)
    {
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center">
            <MudDivider Style="max-width: 45%"/>
            <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">OR</MudTextM3>
            <MudDivider Style="max-width: 45%"/>
        </MudStack>
        <MudStack Spacing="3">
            @if (Model.AuthenticatorEnabled)
            {
                <MudButton
                    Color="Color.Primary"
                    Size="Size.Large"
                    Variant="Variant.Filled"
                    OnClick="@(async () => await OnMethodChanged.InvokeAsync(VerificationMethod.AuthenticatorApp))">
                    Continue with authenticator app
                </MudButton>
            }
            @if (Model.PasskeyEnabled)
            {
                <MudButton
                    Color="Color.Primary"
                    Size="Size.Large"
                    Variant="Variant.Filled"
                    OnClick="@(async () => await OnMethodChanged.InvokeAsync(VerificationMethod.Passkey))">
                    Continue with passkey
                </MudButton>
            }
        </MudStack>
    }
</MudStack>

@code {
    [Parameter] public EventCallback OnAccessConfirmed { get; set; }

    [Parameter] public EventCallback<VerificationMethod> OnMethodChanged { get; set; }

    [Parameter] public ConfirmationContext Context { get; set; } = null!;

    [Parameter] public UserVerificationData Model { get; set; } = new();

    private CodeModel CodeModel { get; set; } = new();

    private readonly PatternMask _mask = new PatternMask("000000");
    private MudForm _form = new();
    private bool _sendStage = true;

    private async Task OnSendAsync()
    {
        var request = new SendCodeRequest
        {
            UserId = UserState.UserId,
            Sender = SenderType.Email,
            Purpose = Context.Purpose,
            Action = Context.Action,
            Payload = new()
            {
                { "To", UserState.Credentials?.Email! }
            }
        };

        var result = await VerificationService.SendCodeAsync(request);

        if (result.Succeeded) _sendStage = false;
        else Snackbar.Add(result.GetError().Description, Severity.Error);
    }

    private async Task OnVerifyAsync()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            var request = new VerifyCodeRequest
            {
                UserId = UserState.UserId,
                Code = CodeModel.Code,
                Purpose = Context.Purpose,
                Action = Context.Action,
                Sender = SenderType.Email
            };

            var result = await VerificationService.VerifyCodeAsync(request);

            if (result.Succeeded) await OnAccessConfirmed.InvokeAsync();
            else Snackbar.Add(result.GetError().Description, Severity.Error);
        }
    }

}