@page "/account/login"

@using eShop.Domain.Types
@using System.Web
@inherits PageBase

@inject ISecurityService SecurityService
@inject IWebAuthNService WebAuthNService
@inject IConfiguration Configuration
@inject LoginValidator Validator

<Title Text="Login"/>

<MudGrid Justify="Justify.Center">
    <MudItem xs="12" sm="10" md="8" lg="6" xl="4" Style="margin-top: 150px">
        <MudStack Spacing="1" Justify="Justify.Center">
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center" Typo="Typo.h4">
                    Log in
                </MudText>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudForm
                    @ref="form"
                    Model="Model"
                    Validation="Validator.ValidateValue">
                    <MudTextField
                        @bind-Value="Model.Login"
                        For="(() => Model.Login)"
                        Label="Login"
                        Immediate
                        Variant="Variant.Outlined"/>
                    <MudPasswordField
                        PasswordMode="true"
                        @bind-Value="Model.Password"
                        For="(() => Model.Password)"
                        Label="Password"
                        Immediate
                        Variant="Variant.Outlined"/>

                    <MudLoadingButton
                        LoadingAdornment="Adornment.End"
                        ButtonType="ButtonType.Button"
                        OnClick="@(async () => await OnSubmitAsync())"
                        StartIcon="@Icons.Material.Filled.Login"
                        Disabled="@(string.IsNullOrEmpty(Model.Password) || string.IsNullOrEmpty(Model.Login))"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        Class="mt-3"
                        FullWidth="true">
                        Log In
                    </MudLoadingButton>
                </MudForm>
            </MudPaper>
            <MudPaper Class="pa-3" Outlined="true">
                <MudLoadingButton
                    LoadingAdornment="Adornment.End"
                    ButtonType="ButtonType.Button"
                    StartIcon="@Icons.Material.Filled.Key"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    OnClick="@(async () => await OnPasskeyAsync())"
                    FullWidth="true">
                    Sign In with Passkey
                </MudLoadingButton>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudGrid Spacing="1" Justify="Justify.Center">
                    <MudItem xs="6">
                        <MudButton
                            ButtonType="ButtonType.Button"
                            StartIcon="@Icons.Custom.Brands.Google"
                            Variant="Variant.Filled"
                            OnClick="@(async () => await OnOAuthAsync("Google"))"
                            Color="Color.Primary"
                            FullWidth="true">
                            Google
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6">
                        <MudButton
                            ButtonType="ButtonType.Button"
                            StartIcon="@Icons.Custom.Brands.Facebook"
                            Variant="Variant.Filled"
                            OnClick="@(async () => await OnOAuthAsync("Facebook"))"
                            Color="Color.Primary"
                            FullWidth="true">
                            Facebook
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6">
                        <MudButton
                            ButtonType="ButtonType.Button"
                            StartIcon="@Icons.Custom.Brands.Microsoft"
                            Variant="Variant.Filled"
                            OnClick="@(async () => await OnOAuthAsync("Microsoft"))"
                            Color="Color.Primary"
                            FullWidth="true">
                            Microsoft
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6">
                        <MudButton
                            ButtonType="ButtonType.Button"
                            StartIcon="@Icons.Custom.Brands.X"
                            Variant="Variant.Filled"
                            OnClick="@(async () => await OnOAuthAsync("X"))"
                            Color="Color.Primary"
                            FullWidth="true">
                            X
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center">
                    Do not have an account?
                    <MudLink OnClick="@(async () => await RouteManager.NavigateAsync("account/register"))">
                        Register
                    </MudLink>
                </MudText>
            </MudPaper>
            <MudPaper Outlined Class="pa-3">
                <MudText Align="Align.Center">
                    Forget your password?
                    <MudLink OnClick="@(async () => await RouteManager.NavigateAsync("account/password/reset"))">
                        Reset password
                    </MudLink>
                </MudText>
            </MudPaper>
        </MudStack>
    </MudItem>
</MudGrid>

@code {

    [SupplyParameterFromQuery(Name = "returnUrl")] public string? ReturnUrl { get; set; } = string.Empty;
    [SupplyParameterFromForm] private LoginModel Model { get; set; } = new();

    private MudForm form = new();

    private async Task OnSubmitAsync()
    {
        await form.Validate();

        if (form.IsValid)
        {
            var request = Mapper.Map(Model);
            var result = await SecurityService.LoginAsync(request);

            if (result.Success)
            {
                var response = result.Get<LoginResponse>()!;

                if (response!.IsTwoFactorEnabled)
                {
                    Snackbar.Add(result.Message, Severity.Success);
                    
                    var url = $"/account/2fa/login?id={response.UserId}";
                    await RouteManager.NavigateAsync(url);
                }
                else
                {
                    await AuthenticationManager.LogInAsync(response!.AccessToken!, response.RefreshToken!);

                    if (string.IsNullOrEmpty(ReturnUrl))
                    {
                        await RouteManager.NavigateAsync("/products");
                    }
                    else
                    {
                        await RouteManager.NavigateAsync(ReturnUrl, true);
                    }
                    
                    Snackbar.Add(result.Message, Severity.Success);
                }
            }
            else
            {
                if (result.Result is null)
                {
                    Snackbar.Add(result.Message, Severity.Error);
                    return;
                }

                var response = result.Get<LoginResponse>()!;
                var userId = response.UserId;
                var email = response.Email;

                if (response is { IsTrustedDevice: false, IsBlockedDevice: false })
                {
                    var device = response.DeviceId;
                    
                    var url = $"/account/device/trust?device={device}&user={userId}&email={email}";

                    Snackbar.Add(result.Message, Severity.Info);
                    await RouteManager.NavigateAsync(url);
                    return;
                }
                
                if (!response.IsEmailConfirmed)
                {
                    var url = $"/account/email/verify?id={userId}&email={email}";

                    Snackbar.Add(result.Message, Severity.Info);
                    await RouteManager.NavigateAsync(url);
                    return;
                }

                if (response.FailedLoginAttempts < response.MaxFailedLoginAttempts && !response.IsLockedOut)
                {
                    var attemptsLeft = response.MaxFailedLoginAttempts - response.FailedLoginAttempts;
                    var message = $"Incorrect password. You have {attemptsLeft} attempts left, then account will be locked out.";
                    Snackbar.Add(message, Severity.Error);
                    return;
                }
                
                if (response is { FailedLoginAttempts: 0, IsLockedOut: false })
                {
                    Snackbar.Add(result.Message, Severity.Error);
                }
                else
                {
                    var url = $"/account/locked-out?id={userId}";
                    await RouteManager.NavigateAsync(url);
                }
            }
        }
    }

    private async Task OnPasskeyAsync()
    {
        var request = new CreatePublicKeyCredentialRequestOptionsRequest()
        {
            Username = "pipidastr"
        };

        var result = await WebAuthNService.CreateAssertionOptionsAsync(request);

        if (result.Success)
        {
            var options = result.Get<PublicKeyCredentialRequestOptions>()!;
            var credential = await Js.InvokeAsync<PublicKeyCredential>("signIn", options);

            var verificationRequest = new VerifyPublicKeyCredentialRequestOptionsRequest()
            {
                Credential = credential
            };

            var verificationResult = await WebAuthNService.VerifyAssertionResponseAsync(verificationRequest);

            if (verificationResult.Success)
            {
                var response = verificationResult.Get<VerifyPublicKeyCredentialRequestOptionsResponse>()!;
                await AuthenticationManager.LogInAsync(response.AccessToken, response.RefreshToken);
                await RouteManager.NavigateAsync("/products");
            }
            else Snackbar.Add(verificationResult.Message, Severity.Error);
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }

    private async Task OnOAuthAsync(string providerName)
    {
        var gatewayPath = Configuration["services:proxy:http:0"]!;
        var baseUri = RouteManager.BaseUri;
        var returnUri = HttpUtility.UrlEncode($"{baseUri}account/oauth/sign-in");
        var fallbackUri = HttpUtility.UrlEncode($"{baseUri}account/oauth/fallback");
        
        var url = $"{gatewayPath}/api/v1/OAuth/login/{providerName}?returnUri={returnUri}&fallbackUri={fallbackUri}";
        await RouteManager.NavigateAsync(url, isExternal: true);
    }

}
