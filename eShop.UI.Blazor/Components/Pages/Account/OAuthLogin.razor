@page "/account/oauth/sign-in/"

@inherits PageBase

@inject IOAuthService OAuthService

@code {
    [SupplyParameterFromQuery(Name = "sessionId")] public string SessionId { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var sessionId = Guid.Parse(SessionId);
        var request = new LoadOAuthSessionRequest() { SessionId = sessionId };

        var result = await OAuthService.LoadSessionAsync(request);

        if (result.Success)
        {
            var response = result.Get<LoadOAuthSessionResponse>()!;

            if (response.SignType == OAuthSignType.SignIn)
            {
                await AuthenticationManager.LogInAsync(response.AccessToken, response.RefreshToken);
                Snackbar.Add($"Successfully signed in with {response.Provider}", Severity.Success);
                await RouteManager.NavigateAsync("/products");
            }
            else if (response.SignType == OAuthSignType.SignUp)
            {
                await RouteManager.NavigateAsync($"/account/oauth/signed-up?provider={response.Provider}");
            }
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Success);
        }
    }

}
