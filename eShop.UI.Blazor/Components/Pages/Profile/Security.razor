@page "/account/security"

@using System.Text.Json
@using System.Text.Json.Serialization
@using eShop.BlazorWebUI.Components.Pages.Profile.Components.Security
@using JsonSerializer = System.Text.Json.JsonSerializer
@using eShop.Domain.Types
@inherits PageBase

@inject IUserService UserService
@inject IDialogService DialogService
@inject ITwoFactorService TwoFactorService
@inject ISecurityService SecurityService

@attribute [Authorize]

<Title Text="Security"></Title>

@if (SecurityModel is not null)
{
    <MudGrid Justify="Justify.Center">
        <MudItem xs="6">
            <MudStack Spacing="2" Justify="Justify.Center">
                <TwoFactorSection
                    Model="SecurityModel"
                    OnSubscribe="@(async (value) => await OnSubscribeAsync(value))"
                    OnUnsubscribe="@(async (value) => await OnUnsubscribeAsync(value))"/>
                <LinkedAccountsSection
                    Model="SecurityModel"
                    OnAllow="@(async (value) => await OnAllowLinkedAccountAsync(value))"
                    OnDisallow="@(async (value) => await OnDisallowLinkedAccountAsync(value))"
                    OnDisconnect="@(async (value) => await OnDisconnectLinkedAccountAsync(value))"/>
                <DevicesSection
                    Model="SecurityModel"
                    OnVerify="@(async (value) => await OnVerifyDeviceAsync(value))"
                    OnBlock="@(async (value) => await OnBlockDeviceAsync(value))"
                    OnUnblock="@(async (value) => await OnUnblockDeviceAsync(value))"/>
                <PasswordSection
                    Model="SecurityModel"
                    OnAdd="@OnAddPasswordAsync"
                    OnChange="@OnChangePasswordAsync"
                    OnReset="@OnResetPasswordAsync"/>
                <PasskeysSection
                    Model="SecurityModel"
                    OnCreate="@OnCreatePasskeyAsync"
                    OnRemove="@(async (value) => await OnPasskeyRemoveAsync(value))"/>
                <RecoverySection
                    Model="SecurityModel"
                    OnGenerateCodes="@OnGenerateRecoveryCodesAsync"
                    OnAdd="@OnAddRecoveryEmailAsync"
                    OnChange="@OnChangeRecoveryEmailAsync"
                    OnRemove="@OnRemoveRecoveryEmailAsync"
                    OnVerify="@OnVerifyRecoveryEmailAsync"/>
            </MudStack>
        </MudItem>
    </MudGrid>
}

@code {
    private UserSecurityModel? SecurityModel { get; set; }

    private string? email;
    private Guid userId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task LoadAsync()
    {
        email = await LocalStorage.GetAsync<string>("email");
        userId = await LocalStorage.GetAsync<Guid>("userId")!;

        var result = await UserService.GetUserSecurityDataAsync(userId);

        if (result.Success)
        {
            var response = result.Get<UserSecurityDto>()!;
            var model = Mapper.Map(response);
            SecurityModel = model;
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }
    }

    private async Task OnCreatePasskeyAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };
        
        var model = new CreatePasskeyModel() { UserId = userId };
        
        var parameters = new DialogParameters<CreatePasskeyDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<CreatePasskeyDialog>("Create passkey", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnChangePasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new ChangePasswordModel() { Id = userId };

        var parameters = new DialogParameters<ChangePasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>("Change password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnAddPasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new AddPasswordModel() { UserId = userId };

        var parameters = new DialogParameters<AddPasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<AddPasswordDialog>("Add password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnResetPasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new ResetPasswordModel() { Id = userId };

        var parameters = new DialogParameters<ResetPasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<ResetPasswordDialog>("Reset password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnSubscribeAsync(string provider)
    {
        if (provider == ProviderTypes.Authenticator)
        {
            await RouteManager.NavigateAsync("/account/2fa/authenticator");
        }
        else
        {
            await RouteManager.NavigateAsync($"/account/2fa/provider/{provider}");
        }
    }

    private async Task OnUnsubscribeAsync(string provider)
    {
        var options = new DialogOptions()
        {
            BackdropClick = true,
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraExtraLarge,
            CloseOnEscapeKey = true
        };

        var parameters = new DialogParameters<Disable2FaProviderDialog>()
        {
            { x => x.UserId, userId },
            { x => x.Provider, provider }
        };

        var dialog = await DialogService.ShowAsync<Disable2FaProviderDialog>("Disable 2FA provider", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnGenerateRecoveryCodesAsync()
    {
        var recoveryCodes = new List<string>();
        var request = new GenerateRecoveryCodesRequest() { UserId = userId };
        var result = await TwoFactorService.GenerateRecoveryCodesAsync(request);

        if (result.Success)
        {
            recoveryCodes = result.Get<List<string>>()!;
        }
        else
        {
            Snackbar.Add(result.Message, Severity.Error);
        }

        var options = new DialogOptions()
        {
            BackdropClick = true,
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraExtraLarge,
            CloseOnEscapeKey = true
        };

        var parameters = new DialogParameters<GenerateRecoveryCodesDialog>()
        {
            { x => x.Codes, recoveryCodes }
        };

        var dialog = await DialogService.ShowAsync<GenerateRecoveryCodesDialog>("Generate 2FA recovery codes", parameters, options);
        var dialogResult = await dialog.Result;

        if (!dialogResult!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnRemoveRecoveryEmailAsync()
    {
        var url = $"/account/recovery-email/remove?recoveryEmail={SecurityModel!.RecoveryEmail}";
        await RouteManager.NavigateAsync(url);
    }
    
    private async Task OnChangeRecoveryEmailAsync()
    {
        var url = $"/account/recovery-email/change?recoveryEmail={SecurityModel!.RecoveryEmail}";
        await RouteManager.NavigateAsync(url);
    }
    
    private async Task OnAddRecoveryEmailAsync()
    {
        var url = "/account/recovery-email/add";
        await RouteManager.NavigateAsync(url);
    }
    
    private async Task OnVerifyRecoveryEmailAsync()
    {
        var url = "/account/recovery-email/verify";
        await RouteManager.NavigateAsync(url);
    }
    
    private async Task OnPasskeyRemoveAsync(Guid id)
    {
        var url = $"/account/passkey/remove?passkey={id}&user={userId}&email={email}";
        await RouteManager.NavigateAsync(url);
    }

    private async Task OnDisconnectLinkedAccountAsync(string provider)
    {
        var url = $"/account/linked-account/disconnect?provider={provider}&user={userId}&email={email}";
        await RouteManager.NavigateAsync(url);
    }

    private async Task OnAllowLinkedAccountAsync(string provider)
    {
        var url = $"/account/linked-account/allow?provider={provider}&user={userId}&email={email}";
        await RouteManager.NavigateAsync(url);
    }

    private async Task OnDisallowLinkedAccountAsync(string provider)
    {
        var url = $"/account/linked-account/disallow?provider={provider}&user={userId}&email={email}";
        await RouteManager.NavigateAsync(url);
    }

    private async Task OnVerifyDeviceAsync(Guid id)
    {
        var url = $"/account/device/verify?device={id}&user={userId}&email={email}";
        await RouteManager.NavigateAsync(url);
    }

    private async Task OnBlockDeviceAsync(Guid id)
    {
        var url = $"/account/device/block?device={id}&user={userId}&email={email}";
        await RouteManager.NavigateAsync(url);
    }

    private async Task OnUnblockDeviceAsync(Guid id)
    {
        var url = $"/account/device/unblock?device={id}&user={userId}&email={email}";
        await RouteManager.NavigateAsync(url);
    }
}