<MudDialog Style="width: 850px;">
    <TitleContent>
        Edit images
    </TitleContent>
    <DialogContent>
        <MudGrid Spacing="0" Justify="Justify.FlexStart">
            <MudFileUpload
                @ref="fileUpload"
                T="IReadOnlyList<IBrowserFile>"
                FilesChanged="@(async (files) => await OnUploadFiles(files))"
                Required="true"
                RequiredError="Upload at least one image"
                Accept=".png, .jpg"
                Hidden="false"
                InputClass="absolute mud-width-full mud-height-full overflow-hidden z-10"
                InputStyle="opacity:0"
                MaximumFileCount="16">
            </MudFileUpload>
            
            @foreach (var image in Model.Images)
            {
                <MudItem xs="3" Style="position: relative; height: 200px; width: 200px; padding: 2px 2px">
                    <MudImage
                        Src="@image.Source"
                        Alt="image"
                        ObjectFit="ObjectFit.Fill"
                        Style="height: 196px; width: 196px"/>
                    <MudIconButton
                        Size="Size.Medium"
                        Variant="Variant.Text"
                        Icon="@Icons.Material.Filled.Close"
                        Style="position: absolute; top: 0; right: -5px"
                        Class="rounded-circle text-black"
                        OnClick="@(() => OnRemove(image.Id))"/>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton
            ButtonType="ButtonType.Button"
            Variant="Variant.Filled"
            Color="Color.Error"
            OnClick="@(() => OnClose())">
            Close
        </MudButton>
        <MudButton
            ButtonType="ButtonType.Button"
            Variant="Variant.Filled"
            Color="Color.Primary"
            OnClick="@(async () => await OnOpenAsync())">
            Upload
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public required IMudDialogInstance Dialog { get; set; }
    [Parameter] public required ProductModel Model { get; set; }
    
    private MudFileUpload<IReadOnlyList<IBrowserFile>> fileUpload = new();

    private void OnRemove(Guid id)
    {
        var image = Model.Images.First(x => x.Id == id);
        Model.Images.Remove(image);

        if (Model.Images.Count == 0)
        {
            OnClose();
        }
        
        StateHasChanged();
    }
    
    private async Task OnUploadFiles(IReadOnlyList<IBrowserFile>? files)
    {
        if (files is not null)
        {
            var images = await ImageHandler.ConvertAsync(files);
            Model.Images.AddRange(images);
        }
    }
    
    private void OnClose() => Dialog.Close(DialogResult.Ok(true));
    private async Task OnOpenAsync() => await fileUpload.OpenFilePickerAsync();
}