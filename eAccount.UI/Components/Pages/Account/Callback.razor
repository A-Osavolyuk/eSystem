@page "/sso/callback"

@using eAccount.Infrastructure.Security.Authentication.JWT
@using eSystem.Core.Security.Authentication.SSO.Token
@using SignInRequest = eAccount.Domain.Requests.SignInRequest
@using SignInResponse = eAccount.Domain.Responses.SignInResponse

@inherits PageBase

@inject ISsoService SsoService
@inject IOptions<ClientOptions> Options
@inject IFetchClient FetchClient
@inject TokenProvider TokenProvider
@inject AuthenticationStateProvider AuthenticationStateProvider

@code {

    [SupplyParameterFromQuery(Name = "code")]
    public string Code { get; set; } = string.Empty;
    
    [SupplyParameterFromQuery(Name = "state")]
    public string State { get; set; } = string.Empty;
    
    [SupplyParameterFromQuery(Name = "return_url")]
    public string? ReturnUrl { get; set; }
    
    private ClientOptions ClientOptions => Options.Value;

    protected override async Task OnInitializedAsync()
    {
        var request = new TokenRequest()
        {
            ClientId = ClientOptions.ClientId,
            ClientSecret = ClientOptions.ClientSecret,
            RedirectUri = ClientOptions.RedirectUri,
            GrantType = GrantTypes.AuthorizationCode,
            Code = Code,
        };
        
        var result = await SsoService.GenerateTokenAsync(request);

        if (result.Success)
        {
            var response = result.Get<TokenResponse>()!;
            await SignInAsync(response.AccessToken, response.RefreshToken);
            var url = string.IsNullOrEmpty(ReturnUrl) ? Links.Profile : ReturnUrl!;
            NavigationManager.NavigateTo(url);
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }
    
    private async Task SignInAsync(string accessToken, string refreshToken)
    {
        TokenProvider.AccessToken = accessToken;

        var request = new SignInRequest()
        {
            AccessToken = accessToken,
            RefreshToken = refreshToken
        };

        var fetchOptions = new FetchOptions()
        {
            Url = $"{NavigationManager.BaseUri}api/authentication/sign-in",
            Method = HttpMethod.Post,
            Body = request
        };

        var result = await FetchClient.FetchAsync(fetchOptions);
        var response = result.Get<SignInResponse>()!;

        var identity = response.Identity;
        var claims = identity.Claims
            .Select(x => new Claim(x.Key, x.Value))
            .ToList();

        var claimsIdentity = new ClaimsIdentity(claims, identity.Scheme);
        var claimsPrincipal = new ClaimsPrincipal(claimsIdentity);

        (AuthenticationStateProvider as JwtAuthenticationStateProvider)!.SignIn(claimsPrincipal);
    }

}