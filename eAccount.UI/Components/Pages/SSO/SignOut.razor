@page "/sso/sign-out"

@using eAccount.Infrastructure.Security.Authentication.JWT

@inherits PageBase

@attribute [Authorize]

@inject IFetchClient FetchClient
@inject ISsoService SsoService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject TokenProvider TokenProvider

<MudGrid Justify="Justify.Center">
    <MudItem xs="3" Style="margin-top: 50px;">
        <MudStack Spacing="2">
            <MudPaper Outlined="true" Class="px-5 py-4">
                <MudGrid>
                    <MudItem xs="1">
                        <MudAvatar Size="Size.Medium">
                            <MudImage
                                Src="/images/avatar.jpg"
                                Alt="Avatar"
                                FallbackSrc="/images/avatar.jpg"/>
                        </MudAvatar>
                    </MudItem>
                    <MudItem xs="10">
                        <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
                            <MudTextM3 Class="pt-2">
                                Signed-in as <strong>@UserState.Credentials?.Username</strong>
                            </MudTextM3>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            <MudButton
                Size="Size.Large"
                Color="Color.Error"
                Variant="Variant.Outlined"
                ButtonType="ButtonType.Button"
                OnClick="@(async () => await OnSignOutAsync())">
                Sign out
            </MudButton>
        </MudStack>
    </MudItem>
</MudGrid>

@code {

    private async Task OnSignOutAsync()
    {
        var request = new SignOutRequest() { UserId = UserState.UserId };
        var result = await SsoService.SignOutAsync(request);

        if (result.Success) await SignOutAsync();
        else Snackbar.Add(result.Message, Severity.Error);
    }

    private async Task SignOutAsync()
    {
        var fetchOptions = new FetchOptions()
        {
            Method = HttpMethod.Post,
            Url = $"{NavigationManager.BaseUri}api/authentication/sign-out",
        };

        var result = await FetchClient.FetchAsync(fetchOptions);
        if (result.Success)
        {
            await (AuthenticationStateProvider as JwtAuthenticationStateProvider)!.SignOutAsync();
            await LocalStorage.ClearAsync();
            TokenProvider.Clear();

            NavigationManager.NavigateTo(Links.SignIn);
        }
    }
}