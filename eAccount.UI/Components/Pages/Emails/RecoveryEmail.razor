@using eSystem.Core.Security.Authorization.Access
@using eSystem.Core.Utilities.Query
@inject ISecurityService SecurityService
@inject ISnackbar Snackbar
@inject UserState UserState
@inject ConfirmationManager ConfirmationManager

<MudPaper Outlined="true" Class="pa-5">
    <MudStack Spacing="0">
        <MudStack Row="true" Spacing="1">
            <MudTextM3 Class="pt-1" Typo="TypoM3.Body" Size="Size.Large">
                @Email.Email
            </MudTextM3>
            <MudTooltip Text="Default email address for an account recovery">
                <MudChip
                    T="string"
                    Class="mx-0"
                    Color="Color.Info"
                    Variant="Variant.Outlined"
                    Size="Size.Small">
                    Recovery
                </MudChip>
            </MudTooltip>
            @if (Email.IsVerified && Email.VerifiedDate.HasValue)
               {
                   <MudTooltip
                       Text="@($"Verified at: {Email.VerifiedDate?.ToString("MM/dd/yyyy HH:mm")}")">
                       <MudChip
                           T="string"
                           Class="mx-0"
                           Color="Color.Success"
                           Variant="Variant.Outlined"
                           Size="Size.Small">
                           Verified
                       </MudChip>
                   </MudTooltip>
               }
               else
               {
                   <MudTooltip Text="This email address is not verified">
                       <MudChip
                           T="string"
                           Class="mx-0"
                           Color="Color.Error"
                           Variant="Variant.Outlined"
                           Size="Size.Small">
                           Unverified
                       </MudChip>
                   </MudTooltip>
               }
            @if (Email.UpdateDate.HasValue)
               {
                   <MudTooltip
                       Text="@($"Last change: {Email.UpdateDate?.ToString("MM/dd/yyyy HH:mm")}")">
                       <MudChip
                           T="string"
                           Class="mx-0"
                           Color="Color.Warning"
                           Variant="Variant.Outlined"
                           Size="Size.Small">
                           Changed
                       </MudChip>
                   </MudTooltip>
               }
            <MudSpacer/>
            <MudMenu
                Dense="true">
                <ActivatorContent>
                    <MudIcon Icon="@Icons.Material.Filled.MoreHoriz"/>
                </ActivatorContent>
                <ChildContent>
                    @if (!Email.IsVerified)
                       {
                           <MudMenuItem Href=@(OnVerify())>
                               <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                   Verify email
                               </MudTextM3>
                           </MudMenuItem>
                       }
                       else
                       {
                           <MudMenuItem Href=@(OnChange())>
                               <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                   Change email
                               </MudTextM3>
                           </MudMenuItem>
                           <MudDivider/>
                           <MudMenuItem
                               OnClick=@(async () => await OnRemove(Email.Email))>
                               <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Color="Color.Error">
                                   Remove email
                               </MudTextM3>
                           </MudMenuItem>
                       }
                </ChildContent>
            </MudMenu>
        </MudStack>
        <MudTextM3 Class="opacity-50" Typo="TypoM3.Body" Size="Size.Small">
            This email address is default for eAccount account access recover.
        </MudTextM3>
    </MudStack>
</MudPaper>

@code {
    [Parameter] public UserEmailDto Email { get; set; } = new();

    [Parameter] public EventCallback OnRefresh { get; set; }
    

    private string OnVerify()
    {
        return QueryBuilder.Create()
            .WithUri(Links.EmailVerifyPage)
            .WithQueryParam("email", Email.Email)
            .WithQueryParam("type", EmailTypes.Recovery)
            .WithQueryParam("return_url", Links.EmailsPage)
            .Build();
    }


    private string OnChange()
    {
        return QueryBuilder.Create()
            .WithUri(Links.EmailChangePage)
            .WithQueryParam("email", Email.Email)
            .WithQueryParam("type", EmailTypes.Recovery)
            .WithQueryParam("return_url", Links.EmailsPage)
            .Build();
    }

    private async Task OnRemove(string email)
    {
        var confirmationResult = await ConfirmationManager.InitiateAsync(PurposeType.Email, ActionType.Remove);
        if (!confirmationResult!.Canceled)
        {
            var request = new RemoveEmailRequest()
            {
                UserId = UserState.UserId,
                Email = email
            };

            var result = await SecurityService.RemoveEmailAsync(request);

            if (result.Success)
            {
                Snackbar.Add("Email was successfully removed", Severity.Success);
                await OnRefresh.InvokeAsync();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
    }
}