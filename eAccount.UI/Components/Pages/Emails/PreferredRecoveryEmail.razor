@using eSystem.Core.Utilities.Query
@inject NavigationManager NavigationManager

<MudPaper Outlined="true" Class="pa-5">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="8">
            <MudStack Spacing="1">
                <MudTextM3 Typo="TypoM3.Title" Size="Size.Medium" Class="fw-bold">
                    Recovery email address
                </MudTextM3>
                <MudTextM3 Typo="TypoM3.Body" Size="Size.Small" Class="opacity-50">
                    Select an email to be used for account recovery. 
                    Will be user as primary after account recovery.
                </MudTextM3>
            </MudStack>
        </MudItem>
        <MudItem xs="4">
            <MudSelectExtended
                T="string"
                Margin="Margin.Dense"
                AnchorOrigin="Origin.BottomCenter"
                Value="@Model.RecoveryEmail?.Email"
                Disabled="@(Model.Emails.All(x => x.Type != EmailType.Secondary || !x.IsVerified))"
                ValueChanged="OnChange"
                Variant="Variant.Outlined"
                Immediate="true">
                @foreach (var email in Model.Emails.Where(x => x is { Type: EmailType.Secondary, IsVerified: true }))
                {
                    <MudSelectItemExtended T="string" Value="email.Email">
                        @email.Email
                    </MudSelectItemExtended>
                }
            </MudSelectExtended>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public UserEmailsModel Model { get; set; } = null!;
    
    private void OnChange(string email)
    {
        var builder = QueryBuilder.Create()
            .WithUri(Links.EmailManagePage)
            .WithQueryParam("email", email)
            .WithQueryParam("type", EmailTypes.Recovery)
            .WithQueryParam("return_url", Links.EmailsPage);
        
        NavigationManager.NavigateTo(builder.Build());
    }
}