@using eSystem.Core.Requests.Auth
@inject UserState UserState
@inject AddEmailValidator Validator
@inject ISecurityService SecurityService
@inject ISnackbar Snackbar

<MudPaper Outlined="true" Class="pa-5">
    <MudStack Spacing="1">
        <MudTextM3 Typo="TypoM3.Title" Size="Size.Medium" Class="fw-bold">
            Add email
        </MudTextM3>
        <MudStack Row="true" Spacing="1">
            <MudForm Model="Model" @ref="form" Validation="Validator.ValidateValue" Spacing="0">
                <MudTextFieldExtended
                    Style="width: 400px"
                    Class="my-0"
                    Margin="Margin.Dense"
                    Typo="Typo.body1"
                    @bind-Value="Model.Email"
                    For="() => Model.Email"
                    Variant="Variant.Outlined"
                    Immediate="true"
                    Clearable="true"
                    Error="@showError"
                    ErrorText="@error"/>
            </MudForm>
            <MudStack Justify="Justify.FlexStart" AlignItems="AlignItems.Center">
                <MudButton
                    Style="height: 39px"
                    Variant="Variant.Outlined"
                    ButtonType="ButtonType.Button"
                    Size="Size.Medium"
                    OnClick="@(async () => await OnAddAsync())">
                    Add
                </MudButton>
            </MudStack>
        </MudStack>
        <MudTextM3 Typo="TypoM3.Body" Size="Size.Small" Class="opacity-50">
            Enter an email address, that will be used as additional.
            Also you will be able to set this email as recovery or primary.
        </MudTextM3>
    </MudStack>
</MudPaper>

@code {
    [Parameter] public EventCallback OnRefresh { get; set; }

    private AddEmailModel Model { get; set; } = new();
    private MudForm form = new();

    private string? error;
    private bool showError = false;

    private async Task OnAddAsync()
    {
        await form.Validate();

        if (form is { IsValid: true, IsTouched: true })
        {
            var request = new CheckEmailRequest()
            {
                UserId = UserState.UserId,
                Email = Model.Email!
            };

            var result = await SecurityService.CheckEmailAsync(request);

            if (result.Success)
            {
                showError = false;
                error = null;
                await AddEmailAsync();
            }
            else
            {
                showError = true;
                error = result.Message;
            }
        }
        else if (!form.IsValid) showError = true;
    }

    private async Task AddEmailAsync()
    {
        var request = new AddEmailRequest()
        {
            UserId = UserState.UserId,
            Email = Model.Email!,
        };

        var result = await SecurityService.AddEmailAsync(request);

        if (result.Success)
        {
            Model = new();
            await OnRefresh.InvokeAsync();
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }

}