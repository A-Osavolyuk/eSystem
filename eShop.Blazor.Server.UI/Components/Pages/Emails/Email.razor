@inject ISecurityService SecurityService
@inject ISnackbar Snackbar
@inject UserState UserState
@inject ConfirmationManager ConfirmationManager

@if (Model is not null)
{
    <MudPaper Outlined="true" Class="pa-5">
        <MudStack Spacing="0">
            <MudStack Row="true" Spacing="1">
                <MudTextM3 Class="pt-1" Typo="TypoM3.Body" Size="Size.Large">
                    @Model.Email
                </MudTextM3>
                @switch (Model.Type)
                {
                    case EmailType.Primary:
                    {
                        <MudTooltip Text="Default email address for eAccount">
                            <MudChip
                                T="string"
                                Class="mx-0"
                                Color="Color.Info"
                                Variant="Variant.Outlined"
                                Size="Size.Small">
                                Primary
                            </MudChip>
                        </MudTooltip>
                        break;
                    }
                    case EmailType.Recovery:
                    {
                        <MudTooltip Text="Default email address for an account recovery">
                            <MudChip
                                T="string"
                                Class="mx-0"
                                Color="Color.Info"
                                Variant="Variant.Outlined"
                                Size="Size.Small">
                                Recovery
                            </MudChip>
                        </MudTooltip>
                        break;
                    }
                    case EmailType.Secondary:
                    {
                        <MudChip
                            T="string"
                            Class="mx-0"
                            Color="Color.Secondary"
                            Variant="Variant.Outlined"
                            Size="Size.Small">
                            Secondary
                        </MudChip>
                        break;
                    }
                }
                @if (Model.IsVerified && Model.VerifiedDate.HasValue)
                {
                    <MudTooltip
                        Text="@($"Verified at: {Model.VerifiedDate?.ToString("MM/dd/yyyy HH:mm")}")">
                        <MudChip
                            T="string"
                            Class="mx-0"
                            Color="Color.Success"
                            Variant="Variant.Outlined"
                            Size="Size.Small">
                            Verified
                        </MudChip>
                    </MudTooltip>
                }
                else
                {
                    <MudTooltip Text="This email address is not verified">
                        <MudChip
                            T="string"
                            Class="mx-0"
                            Color="Color.Error"
                            Variant="Variant.Outlined"
                            Size="Size.Small">
                            Unverified
                        </MudChip>
                    </MudTooltip>
                }
                @if (Model.UpdateDate.HasValue)
                {
                    <MudTooltip
                        Text="@($"Last change: {Model.UpdateDate?.ToString("MM/dd/yyyy HH:mm")}")">
                        <MudChip
                            T="string"
                            Class="mx-0"
                            Color="Color.Warning"
                            Variant="Variant.Outlined"
                            Size="Size.Small">
                            Changed
                        </MudChip>
                    </MudTooltip>
                }
                <MudSpacer/>
                <MudMenu
                    Dense="true">
                    <ActivatorContent>
                        <MudIcon Icon="@Icons.Material.Filled.MoreHoriz"/>
                    </ActivatorContent>
                    <ChildContent>
                        @if (!Model.IsVerified)
                        {
                            switch (Model.Type)
                            {
                                case EmailType.Primary:
                                {
                                    <MudMenuItem Href=@(OnVerify(EmailTypes.Primary))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                            Verify email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    break;
                                }
                                case EmailType.Recovery:
                                {
                                    <MudMenuItem Href=@(OnVerify(EmailTypes.Recovery))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                            Verify email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    break;
                                }
                                case EmailType.Secondary:
                                {
                                    <MudMenuItem Href=@(OnVerify(EmailTypes.Secondary, Model.Email))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                            Verify email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    break;
                                }
                            }
                        }
                        else
                        {
                            switch (Model.Type)
                            {
                                case EmailType.Primary:
                                {
                                    <MudMenuItem Href=@(OnChange(EmailTypes.Primary))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                            Change email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    <MudDivider/>
                                    <MudMenuItem Href=@(OnReset(EmailTypes.Primary))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Color="Color.Error">
                                            Reset email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    break;
                                }
                                case EmailType.Recovery:
                                {
                                    <MudMenuItem Href=@(OnChange(EmailTypes.Recovery))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium">
                                            Change email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    <MudDivider/>
                                    <MudMenuItem OnClick=@(async () => await OnRemove(UserState.Credentials?.RecoveryEmail!))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Color="Color.Error">
                                            Remove email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    break;
                                }
                                case EmailType.Secondary:
                                {
                                    <MudMenuItem OnClick=@(async () => await OnRemove(Model.Email))>
                                        <MudTextM3 Typo="TypoM3.Body" Size="Size.Medium" Color="Color.Error">
                                            Remove email
                                        </MudTextM3>
                                    </MudMenuItem>
                                    break;
                                }
                            }
                        }
                    </ChildContent>
                </MudMenu>
            </MudStack>
            @switch (Model.Type)
            {
                case EmailType.Primary:
                {
                    <MudTextM3 Class="opacity-50" Typo="TypoM3.Body" Size="Size.Small">
                        This email address is default for eAccount security purposes.
                        Also you will receive notifications and verification codes to this email address.
                    </MudTextM3>
                    break;
                }
                case EmailType.Recovery:
                {
                    <MudTextM3 Class="opacity-50" Typo="TypoM3.Body" Size="Size.Small">
                        This email address is default for eAccount account access recover.
                    </MudTextM3>
                    break;
                }
                case EmailType.Secondary:
                {
                    <MudTextM3 Class="opacity-50" Typo="TypoM3.Body" Size="Size.Small">
                        These email address are additional.
                        You can change their roles or just use in your personal purposes.
                    </MudTextM3>
                    break;
                }
            }
        </MudStack>
    </MudPaper>
}

@code {
    [Parameter] 
    public UserEmailDto? Model { get; set; }
    
    [Parameter] 
    public EventCallback OnRefresh { get; set; }
    
    private readonly string returnUrl = HttpUtility.UrlEncode(Links.EmailsPage);

    private string OnVerify(string type, string? email = null)
    {
        if (type == EmailTypes.Secondary && !string.IsNullOrEmpty(email))
        {
            return $"{Links.EmailVerifyPage}?type={type}&email={email}&return_url={returnUrl}";
        }

        return $"{Links.EmailVerifyPage}?type={type}&return_url={returnUrl}";
    }
    
        
    private string OnChange(string type)
    {
        return $"{Links.EmailChangePage}?type={type}&return_url={returnUrl}";
    }
    
    private string OnReset(string type)
    {
        return $"{Links.EmailResetPage}?type={type}&return_url={returnUrl}";
    }
    
    private async Task OnRemove(string email)
    {
        var confirmationResult = await ConfirmationManager.InitiateAsync(PurposeType.Email, ActionType.Remove);
        if (!confirmationResult!.Canceled)
        {
            var request = new RemoveEmailRequest()
            {
                UserId = UserState.UserId,
                Email = email
            };
            
            var result = await SecurityService.RemoveEmailAsync(request);

            if (result.Success)
            {
                Snackbar.Add("Email was successfully removed", Severity.Success);
                await OnRefresh.InvokeAsync();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
    }
}