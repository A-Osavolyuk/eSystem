@inject ISnackbar Snackbar
@inject IUserService UserService
@inject UserState UserState

<MudStack Spacing="3">
    <MudText Typo="Typo.h5">Two-factor authentication (2FA)</MudText>
    <MudPaper Outlined="true" Class="pa-5">
        <MudStack Spacing="3">
            @if (Model is not null)
            {
                <MudStack Spacing="2">
                    @foreach (var provider in Model.Providers)
                    {
                        <MudStack Spacing="1">
                            <MudStack Row="true" Spacing="1">
                                <MudText Style="padding-top: 5px"> With @provider.Name</MudText>
                                @if (provider.Subscribed)
                                {
                                    <MudChip
                                        T="string"
                                        Size="Size.Small"
                                        Variant="Variant.Outlined"
                                        Color="Color.Success">
                                        Enabled
                                    </MudChip>
                                    <MudSpacer/>
                                    <MudTooltip Text="Disable">
                                        <MudIconButton
                                            Color="Color.Error"
                                            Class="pt-1"
                                            Icon="@Icons.Material.Filled.Close"
                                            Variant="Variant.Outlined"
                                            ButtonType="ButtonType.Button"
                                            Href="@($"/account/2fa/provider/disable?provider={provider}")"/>
                                    </MudTooltip>
                                }
                                else
                                {
                                    <MudChip
                                        T="string"
                                        Size="Size.Small"
                                        Variant="Variant.Outlined"
                                        Color="Color.Error">
                                        Disabled
                                    </MudChip>
                                    <MudSpacer/>
                                    <MudTooltip Text="Enable">
                                        <MudIconButton
                                            Color="Color.Success"
                                            Class="pt-1"
                                            Icon="@Icons.Material.Filled.Check"
                                            Variant="Variant.Outlined"
                                            ButtonType="ButtonType.Button"
                                            Href="@OnSubscribe(provider.Name)"/>
                                    </MudTooltip>
                                }
                            </MudStack>
                            @if (provider.UpdateDate.HasValue)
                            {
                                if (provider.Subscribed)
                                {
                                    <MudText
                                        Class="opacity-50"
                                        Style="bottom: -15px"
                                        Typo="Typo.caption">
                                        Enabled at: @provider.UpdateDate?.ToString("MM/dd/yyyy HH:mm")
                                    </MudText>
                                }
                                else
                                {
                                    <MudText
                                        Class="opacity-50"
                                        Style="bottom: -18px"
                                        Typo="Typo.caption">
                                        Disabled at: @provider.UpdateDate?.ToString("MM/dd/yyyy HH:mm")
                                    </MudText>
                                }
                            }
                        </MudStack>
                    }
                </MudStack>
            }
            else
            {
                <MudStack Spacing="1" Justify="Justify.Center" AlignItems="AlignItems.Center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
                    <MudText Align="Align.Center">
                        <strong>Loading...</strong>
                    </MudText>
                </MudStack>
            }
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    private TwoFactorDataModel? Model { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task LoadAsync()
    {
        var result = await UserService.GetUserTwoFactorDataAsync(UserState.UserId);

        if (result.Success)
        {
            var response = result.Get<UserTwoFactorDto>()!;
            Model = new()
            {
                Providers = response.Providers,
                TwoFactorEnabled = response.TwoFactorEnabled
            };
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }

    private string OnSubscribe(string provider)
    {
        return provider == ProviderTypes.Authenticator
            ? "/account/2fa/authenticator/enable"
            : $"/account/2fa/provider/enable?provider={provider}";
    }

    private class TwoFactorDataModel
    {
        public List<UserProviderDto> Providers { get; set; } = [];
        public bool TwoFactorEnabled { get; set; }
    }

}