@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IUserService UserService
@inject UserState UserState

<MudPaper Outlined="true" Class="pa-5">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h6">
            Passkeys
        </MudText>
        @if (Model is not null)
        {
            <MudStack Spacing="0">
                @foreach (var passkey in Model.Passkeys)
                {
                    <MudStack Spacing="0">
                        <MudStack Row="true">
                            <MudStack Spacing="0">
                                <MudText Style="padding-top: 5px">
                                    @passkey.DisplayName
                                </MudText>
                                @if (passkey.CreateDate.HasValue)
                                {
                                    <MudText Align="Align.Start" Typo="Typo.caption" Class="opacity-50">
                                        Created at: @passkey.CreateDate?.ToString("MM/dd/yyyy HH:mm")
                                    </MudText>
                                }
                            </MudStack>
                            <MudSpacer />
                            <MudStack>
                                <MudIconButton 
                                    Icon="@Icons.Material.Filled.Delete"
                                    Color="Color.Error"
                                    Variant="Variant.Outlined"
                                    ButtonType="ButtonType.Button"
                                    Href="@($"/account/passkey/remove?passkey={passkey.Id}")"/>
                            </MudStack>
                        </MudStack>
                    </MudStack>
                }
            </MudStack>
            <MudStack Row="true" Spacing="1">
                <MudButton
                    Color="Color.Primary"
                    ButtonType="ButtonType.Button"
                    Variant="Variant.Filled"
                    OnClick="@(async () => await OnCreatePasskeyAsync())">
                    Create passkey
                </MudButton>
            </MudStack>
        }
        else
        {
            <MudStack Spacing="1" Justify="Justify.Center" AlignItems="AlignItems.Center">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
                <MudText Align="Align.Center">
                    <strong>Loading...</strong>
                </MudText>
            </MudStack>
        }
    </MudStack>
</MudPaper>

@code {
    private PasskeyDataModel? Model { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task LoadAsync()
    {
        var result = await UserService.GetUserPasskeysAsync(UserState.UserId);

        if (result.Success)
        {
            var response = result.Get<List<UserPasskeyDto>>()!;
            Model = new()
            {
                Passkeys = response
            };
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }
    
    private async Task OnCreatePasskeyAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new CreatePasskeyModel() { UserId = UserState.UserId };

        var parameters = new DialogParameters<CreatePasskeyDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<CreatePasskeyDialog>("Create passkey", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private class PasskeyDataModel
    {
        public List<UserPasskeyDto> Passkeys { get; set; } = [];
    }
}