@inject IDialogService DialogService
@inject UserState UserState

<MudStack Spacing="0" Class="px-3">
    <MudStack Row="true" Spacing="0">
        <MudText Typo="Typo.h6" Class="pt-1">Password</MudText>
        @if (Model.Enabled)
        {
            <MudChip 
                T="string"
                Class="mt-2"
                Color="Color.Success"
                Variant="Variant.Outlined"
                Size="Size.Small">
                Enabled
            </MudChip>
        }
        else
        {
            <MudChip 
                T="string"
                Class="mt-2"
                Color="Color.Error"
                Variant="Variant.Outlined"
                Size="Size.Small">
                Disabled
            </MudChip>
        }
        <MudSpacer/>
        @if (!Model.HasPassword)
        {
            <MudButton
                Variant="Variant.Outlined"
                ButtonType="ButtonType.Button"
                OnClick="@(async () => await OnAddPasswordAsync())">
                Add password
            </MudButton>
        }
        else
        {
            <MudMenu
                Dense="true">
                <ActivatorContent>
                    <MudIcon Icon="@Icons.Material.Filled.MoreHoriz"/>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="@(async () => await OnChangePasswordAsync())">
                        Change password
                    </MudMenuItem>
                    <MudMenuItem Href="/account/password/reset">
                        Reset password
                    </MudMenuItem>
                    @if (!Model.Enabled)
                    {
                        <MudMenuItem
                            Href="/account/login/enable?type=password"
                            Class="mud-error-text">
                            Disable method
                        </MudMenuItem>
                    }
                    <MudDivider/>
                    @if (Model.Enabled)
                    {
                        <MudMenuItem
                            Href="/account/login/disable?type=password"
                            Class="mud-error-text">
                            Disable method
                        </MudMenuItem>
                    }
                    <MudMenuItem
                        Href="/account/password/remove"
                        Class="mud-error-text">
                        Remove password
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        }
    </MudStack>
    <MudText Class="opacity-50" Typo="Typo.caption">
        Primary sign-in method by default. 
        You can enable 2FA to add an additional layer of protection.
    </MudText>
</MudStack>

@code {
    [Parameter] public PasswordData Model { get; set; } = new();
    [Parameter] public EventCallback OnRefreshAsync { get; set; }

    private async Task OnChangePasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new ChangePasswordModel() { Id = UserState.UserId };

        var parameters = new DialogParameters<ChangePasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>("Change password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnRefreshAsync.InvokeAsync();
            StateHasChanged();
        }
    }

    private async Task OnAddPasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new AddPasswordModel() { UserId = UserState.UserId };

        var parameters = new DialogParameters<AddPasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<AddPasswordDialog>("Add password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnRefreshAsync.InvokeAsync();
            StateHasChanged();
        }
    }

}