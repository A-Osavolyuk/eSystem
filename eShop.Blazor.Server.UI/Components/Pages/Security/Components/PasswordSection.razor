@inject ISnackbar Snackbar
@inject IUserService UserService
@inject IDialogService DialogService
@inject UserState UserState

<MudPaper Class="pa-5" Outlined="true">
    <MudStack Spacing="4">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h6">
                Password
            </MudText>
            @if (Model.PasswordChangeDate is not null)
            {
                <MudText Align="Align.Start" Typo="Typo.caption" Class="opacity-50 mb-2">
                    Last change: @Model.PasswordChangeDate?.ToString("MM/dd/yyyy HH:mm")
                </MudText>
            }
        </MudStack>
        <MudStack Row="true" Spacing="1">
            @if (Model.HasPassword)
            {
                <MudLoadingButton
                    Color="Color.Primary"
                    Variant="Variant.Filled"
                    ButtonType="ButtonType.Button"
                    OnClick="@(async () => await OnChangePasswordAsync())">
                    Change password
                </MudLoadingButton>
                <MudLoadingButton
                    Color="Color.Error"
                    Variant="Variant.Outlined"
                    ButtonType="ButtonType.Button"
                    Href="/account/password/reset">
                    Reset password
                </MudLoadingButton>
            }
            else
            {
                <MudLoadingButton
                    Color="Color.Primary"
                    Variant="Variant.Filled"
                    ButtonType="ButtonType.Button"
                    OnClick="@(async () => await OnAddPasswordAsync())">
                    Add password
                </MudLoadingButton>
            }
        </MudStack>
    </MudStack>
</MudPaper>

@code {
    private PasswordDataModel Model { get; set; } = new();
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
        }
    }

    private async Task LoadAsync()
    {
        var result = await UserService.GetUserPasswordDatasync(UserState.UserId);

        if (result.Success)
        {
            var response = result.Get<UserPasswordDto>()!;
            Model = new()
            {
                HasPassword = response.HasPassword,
                PasswordChangeDate = response.PasswordChangeDate
            };
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }
    
    private async Task OnChangePasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new ChangePasswordModel() { Id = UserState.UserId };

        var parameters = new DialogParameters<ChangePasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>("Change password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private async Task OnAddPasswordAsync()
    {
        var options = new DialogOptions()
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        var model = new AddPasswordModel() { UserId = UserState.UserId };

        var parameters = new DialogParameters<AddPasswordDialog>()
        {
            { x => x.Model, model }
        };

        var dialog = await DialogService.ShowAsync<AddPasswordDialog>("Add password", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await LoadAsync();
            StateHasChanged();
        }
    }

    private class PasswordDataModel
    {
        public bool HasPassword { get; set; }
        public DateTimeOffset? PasswordChangeDate { get; set; }
    }
}