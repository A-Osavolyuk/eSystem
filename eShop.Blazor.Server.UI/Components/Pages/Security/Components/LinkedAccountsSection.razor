@inject IUserService UserService
@inject ISnackbar Snackbar
@inject UserState UserState

@if (Model.LinkedAccounts.Count > 0)
{
    <MudPaper Outlined="true" Class="pt-3 pl-5 pr-5 pb-5">
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">
                Linked accounts
            </MudText>
            <MudStack Spacing="2">
                @foreach (var provider in Model.LinkedAccounts)
                {
                    <MudStack Spacing="0">
                        <MudStack Row="true" Spacing="1">
                            <MudText Style="padding-top: 5px"> @provider.Name</MudText>
                            @if (provider.IsAllowed)
                            {
                                <MudChip
                                    T="string"
                                    Size="Size.Small"
                                    Variant="Variant.Outlined"
                                    Color="Color.Success">
                                    Allowed
                                </MudChip>
                                <MudSpacer/>
                                <MudTooltip Text="Disallow">
                                    <MudIconButton
                                        Color="Color.Error"
                                        Icon="@Icons.Material.Filled.Close"
                                        Variant="Variant.Outlined"
                                        ButtonType="ButtonType.Button"
                                        Href="@($"/account/linked-account/disallow?provider={provider.Name}")"/>
                                </MudTooltip>
                                <MudTooltip Text="Disconnect">
                                    <MudIconButton
                                        Color="Color.Warning"
                                        Icon="@Icons.Material.Filled.Delete"
                                        Variant="Variant.Outlined"
                                        ButtonType="ButtonType.Button"
                                        Href="@($"/account/linked-account/disconnect?provider={provider.Name}")"/>
                                </MudTooltip>
                            }
                            else
                            {
                                <MudChip
                                    T="string"
                                    Size="Size.Small"
                                    Variant="Variant.Outlined"
                                    Color="Color.Error">
                                    Disallowed
                                </MudChip>
                                <MudSpacer/>
                                <MudTooltip Text="Allow">
                                    <MudIconButton
                                        Color="Color.Success"
                                        Icon="@Icons.Material.Filled.Check"
                                        Variant="Variant.Outlined"
                                        ButtonType="ButtonType.Button"
                                        Href="@($"/account/linked-account/allow?provider={provider.Name}")"/>
                                </MudTooltip>
                                <MudTooltip Text="Disconnect">
                                    <MudIconButton
                                        Color="Color.Warning"
                                        Icon="@Icons.Material.Filled.Delete"
                                        Variant="Variant.Outlined"
                                        ButtonType="ButtonType.Button"
                                        Href="@($"/account/linked-account/disconnect?provider={provider.Name}")"/>
                                </MudTooltip>
                            }
                        </MudStack>
                        @if (provider.IsAllowed)
                        {
                            <MudText
                                Class="opacity-50"
                                Typo="Typo.caption">
                                Linked at: @provider.LinkedDate?.ToString("MM/dd/yyyy HH:mm")
                            </MudText>
                        }
                        else
                        {
                            <MudText
                                Class="opacity-50"
                                Typo="Typo.caption">
                                Disallowed at: @provider.LinkedDate?.ToString("MM/dd/yyyy HH:mm")
                            </MudText>
                        }
                    </MudStack>
                }
            </MudStack>
        </MudStack>
    </MudPaper>
}

@code {
    private LinkedAccountDataModel Model { get; set; } = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAsync();
        }
    }

    private async Task LoadAsync()
    {
        var result = await UserService.GetUserLinkedAccountsAsync(UserState.UserId);

        if (result.Success)
        {
            var response = result.Get<List<UserOAuthProviderDto>>()!;
            Model = new()
            {
                LinkedAccounts = response
            };
        }
        else Snackbar.Add(result.Message, Severity.Error);
    }

    private class LinkedAccountDataModel
    {
        public List<UserOAuthProviderDto> LinkedAccounts { get; set; } = [];
    }
}