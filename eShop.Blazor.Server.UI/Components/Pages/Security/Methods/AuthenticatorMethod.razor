@using eShop.Blazor.Server.UI.Components.Pages.TwoFactor

@inject IDialogService DialogService

<MudStack Row="true" Class="px-5">
    <MudIcon Icon="@Icons.Material.Outlined.Smartphone" Size="Size.Medium" Class="mt-1"/>
    <MudStack Spacing="0">
        <MudStack Row="true" Spacing="1">
            <MudTextM3 Typo="TypoM3.Title" Size="Size.Medium" Class="fw-bold pt-1">
                Authenticator app
            </MudTextM3>
            @if (Model.AuthenticatorEnabled)
            {
                <MudChip
                    T="string"
                    Class="mx-0"
                    Size="Size.Small"
                    Color="Color.Success"
                    Variant="Variant.Outlined">
                    Configured
                </MudChip>
            }
            else
            {
                <MudChip
                    T="string"
                    Class="mx-0"
                    Size="Size.Small"
                    Color="Color.Error"
                    Variant="Variant.Outlined">
                    Not configured
                </MudChip>
            }
            @if (Model.PreferredMethod == TwoFactorMethod.AuthenticatorApp)
            {
                <MudChip
                    T="string"
                    Class="mx-0"
                    Size="Size.Small"
                    Color="Color.Info"
                    Variant="Variant.Outlined">
                    Preferred
                </MudChip>
            }
        </MudStack>
        @if (showConfiguration)
        {
            <AuthenticatorAppConfiguration OnClose="@(() => ToggleConfiguration())"/>
        }
        else
        {
            <MudTextM3 Typo="TypoM3.Body" Size="Size.Small" Class="opacity-50">
                Use an authentication app or browser extension
                to get two-factor authentication codes when prompted.
            </MudTextM3>
        }
    </MudStack>
    <MudSpacer/>
    <MudStack>
        <MudButton
            ButtonType="ButtonType.Button"
            Variant="Variant.Outlined"
            Size="Size.Small"
            OnClick="@(async () => await ShowAsync())"
            Disabled="showConfiguration">
            Edit
        </MudButton>
    </MudStack>
</MudStack>

@code {
    [Parameter] public TwoFactorData Model { get; set; } = new();

    private bool showConfiguration;

    private async Task ShowAsync()
    {
        var confirmationContext = new ConfirmationContext()
        {
            Action = ActionType.Reconfigure,
            Purpose = PurposeType.AuthenticatorApp
        };

        var parameters = new DialogParameters<AccessConfirmationDialog>()
        {
            { dialog => dialog.Context, confirmationContext }
        };

        var options = new DialogOptions()
        {
            BackdropClick = true,
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraExtraLarge
        };

        const string title = "Access confirmation";
        var dialog = await DialogService.ShowAsync<AccessConfirmationDialog>(title, parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled) ToggleConfiguration();
    }

    private void ToggleConfiguration() => showConfiguration = !showConfiguration;
}